<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的订单 - 拍卖系统</title>
    
    <!-- Element UI CSS - 使用CDN -->
    <link rel="stylesheet" href="/css/element-plus.css">
    <!-- 自定义样式 -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 28px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #303133;
            margin: 0;
        }
        
        .page-description {
            color: #606266;
            margin: 10px 0 0 0;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .order-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .order-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .order-item:hover {
            background: #f8f9fa;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .order-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .order-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .order-details h4 {
            margin: 0 0 5px 0;
            color: #303133;
            font-size: 16px;
        }
        
        .order-details p {
            margin: 0;
            color: #606266;
            font-size: 14px;
        }
        
        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-paid {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-shipped {
            background: #e1f5fe;
            color: #0277bd;
        }
        
        .status-delivered {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .order-amount {
            text-align: right;
            margin-bottom: 15px;
        }
        
        .amount-label {
            font-size: 14px;
            color: #909399;
            margin-bottom: 5px;
        }
        
        .amount-value {
            font-size: 20px;
            font-weight: bold;
            color: #f56c6c;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .action-btn {
            min-width: 80px;
        }
        
        .order-timeline {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .timeline-title {
            font-size: 14px;
            color: #606266;
            margin-bottom: 10px;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .timeline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #409EFF;
            margin-right: 10px;
        }
        
        .timeline-content {
            font-size: 14px;
            color: #606266;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .pagination {
            text-align: center;
            margin-top: 30px;
        }
        
        .payment-dialog {
            max-width: 500px;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .payment-method {
            border: 2px solid #e4e7ed;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-method:hover {
            border-color: #409EFF;
        }
        
        .payment-method.selected {
            border-color: #409EFF;
            background: #f0f9ff;
        }
        
        .payment-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .payment-name {
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 顶部导航 -->
        <el-header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="el-icon-gavel"></i>
                    <span>拍卖系统</span>
                </div>
                <div class="nav-links">
                    
                    <el-link href="/auction/user/sessions" :underline="false">拍卖会</el-link>
                    <el-link :underline="false" disabled style="font-weight: bold; color: #409EFF; cursor: not-allowed;">我的订单</el-link>
                    <el-link href="/auction/user/deposits" :underline="false">保证金</el-link>
                    <el-link href="/auction/user/notifications" :underline="false">我的通知</el-link>
                </div>
                <div class="user-info" v-if="isLoggedIn">
                    <el-badge :value="unreadNotifications" :hidden="unreadNotifications === 0" style="margin-right: 15px;">
                        <el-button icon="el-icon-bell" circle @click="goToNotifications"></el-button>
                    </el-badge>
                    <span>欢迎，{{ userInfo.nickname || userInfo.username }}</span>
                    <el-button @click="logout" type="danger" size="small">退出登录</el-button>
                </div>
                <div class="user-info" v-else>
                    <el-button @click="goToLogin" type="primary" size="small">登录</el-button>
                </div>
            </div>
        </el-header>

        <!-- 主要内容 -->
        <el-main class="main-content">
            <!-- 页面标题 -->
            <div class="page-header">
                <h1 class="page-title">我的订单</h1>
                <p class="page-description">查看和管理您的拍卖订单</p>
            </div>

            <!-- 筛选条件 -->
            <div class="filter-section">
                <el-row :gutter="20">
                    <el-col :span="6">
                        <el-input 
                            v-model="searchKeyword" 
                            placeholder="搜索订单号或拍品名称"
                            @input="handleSearch"
                            clearable>
                            <template #prefix>
                                <i class="el-icon-search"></i>
                            </template>
                        </el-input>
                    </el-col>
                    <el-col :span="4">
                        <el-select 
                            v-model="statusFilter" 
                            placeholder="状态筛选"
                            @change="handleFilter"
                            clearable>
                            <el-option label="待支付" value="pending"></el-option>
                            <el-option label="已支付" value="paid"></el-option>
                            <el-option label="已发货" value="shipped"></el-option>
                            <el-option label="已收货" value="delivered"></el-option>
                            <el-option label="已取消" value="cancelled"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="4">
                        <el-date-picker 
                            v-model="dateRange" 
                            type="daterange" 
                            range-separator="至"
                            start-placeholder="开始日期"
                            end-placeholder="结束日期"
                            @change="handleFilter">
                        </el-date-picker>
                    </el-col>
                    <el-col :span="4">
                        <el-button @click="resetFilter" type="info">重置筛选</el-button>
                    </el-col>
                </el-row>
            </div>

            <!-- 订单列表 -->
            <div class="order-list">
                <div v-if="loading" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading"><Loading /></el-icon>
                    <p>加载中...</p>
                </div>
                
                <div v-else-if="filteredOrders.length === 0" class="empty-state">
                    <i class="el-icon-document empty-icon"></i>
                    <h3>暂无订单</h3>
                    <p>您还没有任何订单记录</p>
                </div>
                
                <div v-else>
                    <div 
                        v-for="order in filteredOrders" 
                        :key="order.id" 
                        class="order-item">
                        
                        <div class="order-header">
                            <div class="order-info">
                                <img :src="order.itemImage || '/images/default-item.jpg'" :alt="order.itemName" class="order-image">
                                <div class="order-details">
                                    <h4>{{ order.itemName }}</h4>
                                    <p>订单号: {{ order.orderNumber }}</p>
                                    <p>成交时间: {{ formatTime(order.createTime) }}</p>
                                </div>
                            </div>
                            <div class="order-status" :class="getStatusClass(order.status)">
                                {{ getStatusText(order.status) }}
                            </div>
                        </div>
                        
                        <div class="order-amount">
                            <div class="amount-label">成交金额</div>
                            <div class="amount-value">¥{{ order.totalAmount }}</div>
                        </div>
                        
                        <div class="order-actions">
                            <el-button 
                                v-if="order.status === 'pending'"
                                type="primary" 
                                @click="showPaymentDialog(order)"
                                class="action-btn">
                                立即支付
                            </el-button>
                            <el-button 
                                v-if="order.status === 'pending'"
                                type="danger" 
                                @click="cancelOrder(order)"
                                class="action-btn">
                                取消订单
                            </el-button>
                            <el-button 
                                v-if="order.status === 'shipped'"
                                type="success" 
                                @click="confirmReceive(order)"
                                class="action-btn">
                                确认收货
                            </el-button>
                            <el-button 
                                type="info" 
                                @click="viewOrderDetail(order)"
                                class="action-btn">
                                查看详情
                            </el-button>
                        </div>
                        
                        <div class="order-timeline" v-if="order.timeline && order.timeline.length > 0">
                            <div class="timeline-title">订单进度</div>
                            <div 
                                v-for="event in order.timeline" 
                                :key="event.id" 
                                class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    {{ event.description }} - {{ formatTime(event.createTime) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分页 -->
            <div class="pagination" v-if="totalPages > 1">
                <el-pagination
                    v-model:current-page="currentPage"
                    :page-size="pageSize"
                    :total="totalCount"
                    layout="prev, pager, next, jumper"
                    @current-change="handlePageChange">
                </el-pagination>
            </div>
        </el-main>

        <!-- 支付对话框 -->
        <el-dialog 
            v-model="paymentDialogVisible" 
            title="订单支付" 
            width="500px"
            class="payment-dialog">
            <div v-if="currentOrder">
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3>{{ currentOrder.itemName }}</h3>
                    <p style="color: #606266;">订单号: {{ currentOrder.orderNumber }}</p>
                    <p style="font-size: 24px; color: #f56c6c; font-weight: bold;">
                        支付金额: ¥{{ currentOrder.totalAmount }}
                    </p>
                </div>
                
                <div class="payment-methods">
                    <div 
                        v-for="method in paymentMethods" 
                        :key="method.value"
                        class="payment-method"
                        :class="{ selected: selectedPaymentMethod === method.value }"
                        @click="selectedPaymentMethod = method.value">
                        <i :class="method.icon" class="payment-icon"></i>
                        <div class="payment-name">{{ method.label }}</div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <el-button @click="paymentDialogVisible = false">取消</el-button>
                    <el-button 
                        type="primary" 
                        @click="processPayment"
                        :loading="paying">
                        确认支付
                    </el-button>
                </div>
            </div>
        </el-dialog>
    </div>

    <!-- Element UI JS - 使用CDN -->
    <script src="/js/vue.js"></script>
    <script src="/js/element-plus.js"></script>
    <script src="/js/axios.js"></script>
    
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    loading: false,
                    isLoggedIn: false,
                    userInfo: {},
                    unreadNotifications: 0,
                    searchKeyword: '',
                    statusFilter: '',
                    dateRange: null,
                    orders: [],
                    currentPage: 1,
                    pageSize: 10,
                    totalCount: 0,
                    paymentDialogVisible: false,
                    currentOrder: null,
                    selectedPaymentMethod: '',
                    paying: false,
                    paymentMethods: [
                        { value: 'alipay', label: '支付宝', icon: 'el-icon-alipay' },
                        { value: 'wechat', label: '微信支付', icon: 'el-icon-wechat' },
                        { value: 'bank', label: '银行卡', icon: 'el-icon-bank' }
                    ]
                }
            },
            computed: {
                filteredOrders() {
                    let filtered = this.orders;
                    
                    if (this.searchKeyword) {
                        filtered = filtered.filter(order => 
                            order.orderNumber.toLowerCase().includes(this.searchKeyword.toLowerCase()) ||
                            order.itemName.toLowerCase().includes(this.searchKeyword.toLowerCase())
                        );
                    }
                    
                    if (this.statusFilter) {
                        filtered = filtered.filter(order => order.status === this.statusFilter);
                    }
                    
                    if (this.dateRange && this.dateRange.length === 2) {
                        const startDate = new Date(this.dateRange[0]);
                        const endDate = new Date(this.dateRange[1]);
                        filtered = filtered.filter(order => {
                            const orderDate = new Date(order.createTime);
                            return orderDate >= startDate && orderDate <= endDate;
                        });
                    }
                    
                    return filtered;
                },
                totalPages() {
                    return Math.ceil(this.totalCount / this.pageSize);
                }
            },
            mounted() {
                this.setupAxiosInterceptors();
                this.checkLoginStatus();
                if (this.isLoggedIn) {
                    this.loadOrders();
                    this.loadUnreadNotifications();
                    // 每30秒刷新未读通知数
                    setInterval(() => {
                        if (this.isLoggedIn) {
                            this.loadUnreadNotifications();
                        }
                    }, 30000);
                }
            },
            methods: {
                // 设置axios拦截器
                setupAxiosInterceptors() {
                    // 请求拦截器 - 自动添加Authorization头
                    axios.interceptors.request.use(
                        config => {
                            const token = localStorage.getItem('accessToken');
                            if (token) {
                                config.headers.Authorization = `Bearer ${token}`;
                            }
                            return config;
                        },
                        error => {
                            return Promise.reject(error);
                        }
                    );
                    
                    // 响应拦截器 - 处理401错误
                    axios.interceptors.response.use(
                        response => response,
                        async error => {
                            if (error.response && error.response.status === 401) {
                                // 尝试刷新Token
                                const refreshToken = localStorage.getItem('refreshToken');
                                if (refreshToken) {
                                    try {
                                        const response = await axios.post('/api/auth/refresh', {
                                            refreshToken: refreshToken
                                        });
                                        
                                        if (response.data.code === 200) {
                                            const newAccessToken = response.data.data.accessToken;
                                            localStorage.setItem('accessToken', newAccessToken);
                                            error.config.headers.Authorization = `Bearer ${newAccessToken}`;
                                            return axios.request(error.config);
                                        }
                                    } catch (refreshError) {
                                        console.error('Token刷新失败:', refreshError);
                                    }
                                }
                                
                                // 刷新失败，清除token并跳转
                                localStorage.removeItem('accessToken');
                                localStorage.removeItem('refreshToken');
                                localStorage.removeItem('userInfo');
                                this.isLoggedIn = false;
                                this.userInfo = {};
                                ElMessage.error('登录已过期，请重新登录');
                                window.location.href = '/auction/login';
                            }
                            return Promise.reject(error);
                        }
                    );
                },
                
                // 检查登录状态
                checkLoginStatus() {
                    const accessToken = localStorage.getItem('accessToken');
                    const refreshToken = localStorage.getItem('refreshToken');
                    const userInfoStr = localStorage.getItem('userInfo');
                    
                    if (accessToken && refreshToken) {
                        this.isLoggedIn = true;
                        if (userInfoStr) {
                            this.userInfo = JSON.parse(userInfoStr);
                        } else {
                            this.userInfo = {
                                username: 'buyer1',
                                nickname: '买家1'
                            };
                        }
                    } else {
                        // 未登录，跳转到登录页
                        this.isLoggedIn = false;
                        ElMessage.warning('请先登录');
                        window.location.href = '/auction/login';
                    }
                },
                
                // 加载订单列表
                loadOrders() {
                    this.loading = true;
                    axios.get('/api/user/orders', {
                        params: {
                            page: this.currentPage,
                            size: this.pageSize
                        }
                    })
                    .then(response => {
                        console.log('订单接口返回:', response.data);
                        if (response.data.code === 200) {
                            // 后端返回的数据结构是 data.data.data
                            const result = response.data.data;
                            this.orders = result.data || [];
                            this.totalCount = result.total || 0;
                            console.log('订单列表:', this.orders);
                            console.log('订单总数:', this.totalCount);
                        } else {
                            ElMessage.error(response.data.message || '加载订单列表失败');
                        }
                    })
                    .catch(error => {
                        console.error('加载订单列表错误:', error);
                        ElMessage.error('加载订单列表失败');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
                },
                
                // 搜索
                handleSearch() {
                    // 搜索逻辑在 computed 中处理
                },
                
                // 筛选
                handleFilter() {
                    // 筛选逻辑在 computed 中处理
                },
                
                // 重置筛选
                resetFilter() {
                    this.searchKeyword = '';
                    this.statusFilter = '';
                    this.dateRange = null;
                },
                
                // 分页
                handlePageChange(page) {
                    this.currentPage = page;
                    this.loadOrders();
                },
                
                // 获取状态样式类
                getStatusClass(status) {
                    const statusMap = {
                        'pending': 'status-pending',
                        'paid': 'status-paid',
                        'shipped': 'status-shipped',
                        'delivered': 'status-delivered',
                        'cancelled': 'status-cancelled'
                    };
                    return statusMap[status] || 'status-pending';
                },
                
                // 获取状态文本
                getStatusText(status) {
                    const statusMap = {
                        'pending': '待支付',
                        'paid': '已支付',
                        'shipped': '已发货',
                        'delivered': '已收货',
                        'cancelled': '已取消'
                    };
                    return statusMap[status] || status;
                },
                
                // 格式化时间
                formatTime(time) {
                    return new Date(time).toLocaleString('zh-CN');
                },
                
                // 显示支付对话框
                showPaymentDialog(order) {
                    this.currentOrder = order;
                    this.selectedPaymentMethod = '';
                    this.paymentDialogVisible = true;
                },
                
                // 处理支付
                processPayment() {
                    if (!this.selectedPaymentMethod) {
                        ElMessage.error('请选择支付方式');
                        return;
                    }
                    
                    this.paying = true;
                    const paymentData = {
                        orderId: this.currentOrder.id,
                        paymentMethod: this.selectedPaymentMethod
                    };
                    
                    axios.post('/api/user/orders/pay', paymentData)
                        .then(response => {
                            if (response.data.code === 200) {
                                ElMessage.success('支付成功');
                                this.paymentDialogVisible = false;
                                this.loadOrders();
                            } else {
                                ElMessage.error(response.data.message || '支付失败');
                            }
                        })
                        .catch(error => {
                            console.error('支付错误:', error);
                            ElMessage.error('支付失败，请稍后重试');
                        })
                        .finally(() => {
                            this.paying = false;
                        });
                },
                
                // 取消订单
                cancelOrder(order) {
                    ElMessageBox.confirm('确定要取消这个订单吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        axios.post(`/api/user/orders/${order.id}/cancel`)
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success('订单已取消');
                                    this.loadOrders();
                                } else {
                                    ElMessage.error(response.data.message || '取消失败');
                                }
                            })
                            .catch(error => {
                                console.error('取消订单错误:', error);
                                ElMessage.error('取消失败，请稍后重试');
                            });
                    });
                },
                
                // 确认收货
                confirmReceive(order) {
                    ElMessageBox.confirm('确定已收到商品吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        axios.post(`/api/user/orders/${order.id}/confirm`)
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success('确认收货成功');
                                    this.loadOrders();
                                } else {
                                    ElMessage.error(response.data.message || '确认收货失败');
                                }
                            })
                            .catch(error => {
                                console.error('确认收货错误:', error);
                                ElMessage.error('确认收货失败，请稍后重试');
                            });
                    });
                },
                
                // 查看订单详情
                viewOrderDetail(order) {
                    // 跳转到订单详情页面
                    window.location.href = `/auction/user/orders/${order.id}`;
                },
                
                // 跳转到登录页面
                async loadUnreadNotifications() {
                    try {
                        const response = await axios.get('/api/notifications/unread-count');
                        if (response.data.code === 200) {
                            this.unreadNotifications = response.data.data;
                        }
                    } catch (error) {
                        console.error('获取未读通知数失败:', error);
                    }
                },
                
                goToNotifications() {
                    window.location.href = '/auction/user/notifications';
                },
                
                goToLogin() {
                    window.location.href = '/auction/login';
                },
                
                // 退出登录
                logout() {
                    ElMessageBox.confirm('确定要退出登录吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userInfo');
                        axios.post('/api/auth/logout').finally(() => {
                            this.isLoggedIn = false;
                            this.userInfo = {};
                            ElMessage.success('已退出登录');
                            window.location.reload();
                        });
                    });
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
    
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的订单 - 拍卖系统</title>
    
    <!-- Element UI CSS - 使用CDN -->
    <link rel="stylesheet" href="/css/element-plus.css">
    <!-- 自定义样式 -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 28px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #303133;
            margin: 0;
        }
        
        .page-description {
            color: #606266;
            margin: 10px 0 0 0;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .order-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .order-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .order-item:hover {
            background: #f8f9fa;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .order-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .order-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .order-details h4 {
            margin: 0 0 5px 0;
            color: #303133;
            font-size: 16px;
        }
        
        .order-details p {
            margin: 0;
            color: #606266;
            font-size: 14px;
        }
        
        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-paid {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-shipped {
            background: #e1f5fe;
            color: #0277bd;
        }
        
        .status-delivered {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .order-amount {
            text-align: right;
            margin-bottom: 15px;
        }
        
        .amount-label {
            font-size: 14px;
            color: #909399;
            margin-bottom: 5px;
        }
        
        .amount-value {
            font-size: 20px;
            font-weight: bold;
            color: #f56c6c;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .action-btn {
            min-width: 80px;
        }
        
        .order-timeline {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .timeline-title {
            font-size: 14px;
            color: #606266;
            margin-bottom: 10px;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .timeline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #409EFF;
            margin-right: 10px;
        }
        
        .timeline-content {
            font-size: 14px;
            color: #606266;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .pagination {
            text-align: center;
            margin-top: 30px;
        }
        
        .payment-dialog {
            max-width: 500px;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .payment-method {
            border: 2px solid #e4e7ed;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-method:hover {
            border-color: #409EFF;
        }
        
        .payment-method.selected {
            border-color: #409EFF;
            background: #f0f9ff;
        }
        
        .payment-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .payment-name {
            font-size: 14px;
            font-weight: bold;
        }
        
        .payment-detail-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .payment-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e4e7ed;
        }
        
        .payment-detail-item:last-child {
            border-bottom: none;
            padding-top: 15px;
            margin-top: 5px;
            border-top: 2px dashed #e4e7ed;
        }
        
        .payment-detail-label {
            font-size: 14px;
            color: #606266;
        }
        
        .payment-detail-value {
            font-size: 16px;
            font-weight: bold;
            color: #303133;
        }
        
        .payment-detail-value.highlight {
            color: #f56c6c;
            font-size: 20px;
        }
        
        .payment-detail-value.success {
            color: #67C23A;
        }
        
        .payment-detail-value.warning {
            color: #E6A23C;
        }
        
        .balance-warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .balance-warning-box h4 {
            margin: 0 0 10px 0;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .balance-warning-box p {
            margin: 0;
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 顶部导航 -->
        <el-header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="el-icon-gavel"></i>
                    <span>拍卖系统</span>
                </div>
                <div class="nav-links">
                    
                    <el-link href="/auction/user/sessions" :underline="false">拍卖会</el-link>
                    <el-link :underline="false" disabled style="font-weight: bold; color: #409EFF; cursor: not-allowed;">我的订单</el-link>
                    <el-link href="/auction/user/deposits" :underline="false">保证金</el-link>
                    <el-link href="/auction/user/addresses" :underline="false">收货地址</el-link>
                    <el-link href="/auction/user/notifications" :underline="false">我的通知</el-link>
                </div>
                <div class="user-info" v-if="isLoggedIn">
                    <el-badge :value="unreadNotifications" :hidden="unreadNotifications === 0" style="margin-right: 15px;">
                        <el-button icon="el-icon-bell" circle @click="goToNotifications"></el-button>
                    </el-badge>
                    <span>欢迎，{{ userInfo.nickname || userInfo.username }}</span>
                    <el-button @click="logout" type="danger" size="small">退出登录</el-button>
                </div>
                <div class="user-info" v-else>
                    <el-button @click="goToLogin" type="primary" size="small">登录</el-button>
                </div>
            </div>
        </el-header>

        <!-- 主要内容 -->
        <el-main class="main-content">
            <!-- 页面标题 -->
            <div class="page-header">
                <h1 class="page-title">我的订单</h1>
                <p class="page-description">查看和管理您的拍卖订单</p>
            </div>

            <!-- 筛选条件 -->
            <div class="filter-section">
                <el-row :gutter="20">
                    <el-col :span="6">
                        <el-input 
                            v-model="searchKeyword" 
                            placeholder="搜索订单号或拍品名称"
                            @input="handleSearch"
                            clearable>
                            <template #prefix>
                                <i class="el-icon-search"></i>
                            </template>
                        </el-input>
                    </el-col>
                    <el-col :span="4">
                        <el-select 
                            v-model="statusFilter" 
                            placeholder="状态筛选"
                            @change="handleFilter"
                            clearable>
                            <el-option label="待支付" value="pending"></el-option>
                            <el-option label="已支付" value="paid"></el-option>
                            <el-option label="已发货" value="shipped"></el-option>
                            <el-option label="已收货" value="delivered"></el-option>
                            <el-option label="已取消" value="cancelled"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="4">
                        <el-date-picker 
                            v-model="dateRange" 
                            type="daterange" 
                            range-separator="至"
                            start-placeholder="开始日期"
                            end-placeholder="结束日期"
                            @change="handleFilter">
                        </el-date-picker>
                    </el-col>
                    <el-col :span="4">
                        <el-button @click="resetFilter" type="info">重置筛选</el-button>
                    </el-col>
                </el-row>
            </div>

            <!-- 订单列表 -->
            <div class="order-list">
                <div v-if="loading" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading"><Loading /></el-icon>
                    <p>加载中...</p>
                </div>
                
                <div v-else-if="filteredOrders.length === 0" class="empty-state">
                    <i class="el-icon-document empty-icon"></i>
                    <h3>暂无订单</h3>
                    <p>您还没有任何订单记录</p>
                </div>
                
                <div v-else>
                    <div 
                        v-for="order in filteredOrders" 
                        :key="order.id" 
                        class="order-item">
                        
                        <div class="order-header">
                            <div class="order-info">
                                <img :src="order.itemImage || '/images/default-item.jpg'" :alt="order.itemName" class="order-image">
                                <div class="order-details">
                                    <h4>{{ order.itemName }}</h4>
                                    <p>订单号: {{ order.orderNumber }}</p>
                                    <p>成交时间: {{ formatTime(order.createTime) }}</p>
                                </div>
                            </div>
                            <div class="order-status" :class="getStatusClass(order.status)">
                                {{ getStatusText(order.status) }}
                            </div>
                        </div>
                        
                        <div class="order-amount">
                            <div class="amount-label">成交金额</div>
                            <div class="amount-value">¥{{ Number(order.totalAmount || 0).toFixed(2) }}</div>
                        </div>
                        
                        <div class="order-actions">
                            <el-button 
                                v-if="order.status === 1 || order.status === 'pending'"
                                type="primary" 
                                @click="showPaymentDialog(order)"
                                class="action-btn">
                                立即支付
                            </el-button>
                            <el-button 
                                v-if="order.status === 1 || order.status === 'pending'"
                                type="danger" 
                                @click="cancelOrder(order)"
                                class="action-btn">
                                取消订单
                            </el-button>
                            <el-button 
                                v-if="order.status === 3 || order.status === 'shipped'"
                                type="success" 
                                @click="confirmReceive(order)"
                                class="action-btn">
                                确认收货
                            </el-button>
                        </div>
                        
                        <div class="order-timeline" v-if="order.timeline && order.timeline.length > 0">
                            <div class="timeline-title">订单进度</div>
                            <div 
                                v-for="event in order.timeline" 
                                :key="event.id" 
                                class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    {{ event.description }} - {{ formatTime(event.createTime) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分页 -->
            <div class="pagination" v-if="totalPages > 1">
                <el-pagination
                    v-model:current-page="currentPage"
                    :page-size="pageSize"
                    :total="totalCount"
                    layout="prev, pager, next, jumper"
                    @current-change="handlePageChange">
                </el-pagination>
            </div>
        </el-main>

        <!-- 支付对话框 -->
        <el-dialog 
            v-model="paymentDialogVisible" 
            title="订单支付" 
            width="600px"
            class="payment-dialog">
            <div v-if="currentOrder">
                <!-- 订单信息 -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0;">{{ currentOrder.itemName }}</h3>
                    <p style="color: #909399; font-size: 13px; margin: 0;">订单号: {{ currentOrder.orderNo }}</p>
                </div>
                
                <!-- 配送方式选择 -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #303133;">选择配送方式</h4>
                    <el-radio-group v-model="deliveryMethod" size="large" @change="onDeliveryMethodChange">
                        <el-radio :label="1" border style="margin-right: 15px;">
                            <i class="el-icon-truck"></i> 物流配送
                            <span v-if="sessionIsFreeShipping === 1" style="color: #67C23A; font-size: 12px; margin-left: 5px;">
                                （包邮 免运费）
                            </span>
                            <span v-else style="color: #E6A23C; font-size: 12px; margin-left: 5px;">
                                （+¥{{ actualShippingFee.toFixed(2) }}）
                            </span>
                        </el-radio>
                        <el-radio :label="2" border>
                            <i class="el-icon-place"></i> 线下自提
                            <span style="color: #67C23A; font-size: 12px; margin-left: 5px;">（免运费）</span>
                        </el-radio>
                    </el-radio-group>
                </div>
                
                <!-- 物流公司选择（物流配送时显示且非包邮） -->
                <div v-if="deliveryMethod === 1 && sessionIsFreeShipping !== 1" style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #303133;">选择物流公司</h4>
                    <el-radio-group v-model="selectedLogisticsCompanyId" @change="onLogisticsCompanyChange" style="width: 100%;">
                        <div 
                            v-for="company in logisticsCompanies" 
                            :key="company.id"
                            style="margin-bottom: 10px;">
                            <el-radio :label="company.id" border style="width: 100%; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">
                                            {{ company.companyName }}
                                        </div>
                                        <div style="color: #909399; font-size: 13px;">
                                            基础运费：¥{{ company.baseFee }} | 保价费率：{{ company.insuranceRate }}%
                                        </div>
                                    </div>
                                    <div style="text-align: right; color: #f56c6c; font-weight: bold;">
                                        ¥{{ calculateCompanyFee(company).toFixed(2) }}
                                    </div>
                                </div>
                            </el-radio>
                        </div>
                    </el-radio-group>
                </div>
                
                <!-- 收货地址（物流配送时显示） -->
                <div v-if="deliveryMethod === 1" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; font-size: 16px; color: #303133;">收货信息</h4>
                        <el-button 
                            text 
                            type="primary" 
                            @click="goToAddressManage"
                            style="font-size: 13px;">
                            <i class="el-icon-setting"></i> 管理地址
                        </el-button>
                    </div>
                    
                    <!-- 地址选择器 -->
                    <div v-if="savedAddresses.length > 0" style="margin-bottom: 15px;">
                        <el-radio-group v-model="selectedAddressId" @change="onAddressSelect" style="width: 100%;">
                            <div 
                                v-for="addr in savedAddresses" 
                                :key="addr.id"
                                style="margin-bottom: 10px;">
                                <el-radio :label="addr.id" border style="width: 100%; padding: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; margin-bottom: 5px;">
                                                {{ addr.receiverName }} {{ addr.receiverPhone }}
                                                <el-tag v-if="addr.isDefault === 1" size="small" type="primary" style="margin-left: 8px;">默认</el-tag>
                                                <el-tag v-if="addr.tag" size="small" style="margin-left: 8px;">{{ addr.tag }}</el-tag>
                                            </div>
                                            <div style="color: #909399; font-size: 13px;">{{ addr.fullAddress }}</div>
                                        </div>
                                    </div>
                                </el-radio>
                            </div>
                        </el-radio-group>
                    </div>
                    
                    <!-- 手动输入选项 -->
                    <el-collapse-transition>
                        <div v-show="selectedAddressId === 0 || savedAddresses.length === 0">
                            <el-divider v-if="savedAddresses.length > 0" content-position="center">
                                <el-button text @click="selectedAddressId = 0">或手动输入地址</el-button>
                            </el-divider>
                            <el-form :model="receiverInfo" label-width="80px" size="default">
                                <el-form-item label="收货人" required>
                                    <el-input v-model="receiverInfo.name" placeholder="请输入收货人姓名"></el-input>
                                </el-form-item>
                                <el-form-item label="联系电话" required>
                                    <el-input v-model="receiverInfo.phone" placeholder="请输入联系电话"></el-input>
                                </el-form-item>
                                <el-form-item label="收货地址" required>
                                    <el-input 
                                        v-model="receiverInfo.address" 
                                        type="textarea" 
                                        :rows="2"
                                        placeholder="请输入详细收货地址">
                                    </el-input>
                                </el-form-item>
                            </el-form>
                        </div>
                    </el-collapse-transition>
                </div>
                
                <!-- 自提地址提示（线下自提时显示） -->
                <div v-if="deliveryMethod === 2" style="margin-bottom: 20px;">
                    <el-alert 
                        title="自提地址" 
                        type="success" 
                        :closable="false">
                        <template #default>
                            <p style="margin: 0; font-size: 14px; line-height: 1.6;">
                                📍 <strong>拍卖行地址：</strong>北京市朝阳区建国路XX号XX大厦10层<br>
                                ⏰ <strong>自提时间：</strong>工作日 9:00-18:00<br>
                                📞 <strong>联系电话：</strong>010-12345678<br><br>
                                请在支付成功后3个工作日内前往自提，逾期未取视为放弃。
                            </p>
                        </template>
                    </el-alert>
                </div>
                
                <!-- 支付明细 -->
                <div class="payment-detail-box">
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">拍品成交价</span>
                        <span class="payment-detail-value">¥{{ Number(currentOrder.totalAmount || 0).toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">佣金 ({{ (sessionCommissionRate * 100).toFixed(1) }}%)</span>
                        <span class="payment-detail-value warning">+¥{{ commissionFee.toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">保证金抵扣</span>
                        <span class="payment-detail-value success">-¥{{ Number(currentOrder.depositAmount || 0).toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">商品尾款</span>
                        <span class="payment-detail-value">¥{{ Number(currentOrder.balanceAmount || 0).toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item" v-if="deliveryMethod === 1 && actualShippingFee > 0">
                        <span class="payment-detail-label">物流费用</span>
                        <span class="payment-detail-value warning">+¥{{ actualShippingFee.toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item" v-if="deliveryMethod === 2 || sessionIsFreeShipping === 1">
                        <span class="payment-detail-label">配送方式</span>
                        <span class="payment-detail-value success">
                            {{ deliveryMethod === 2 ? '线下自提（免运费）' : '包邮（免运费）' }}
                        </span>
                    </div>
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">实付金额</span>
                        <span class="payment-detail-value highlight">¥{{ actualPayAmount.toFixed(2) }}</span>
                    </div>
                </div>
                
                <!-- 保证金余额信息 -->
                <div class="payment-detail-box">
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">您的可用保证金</span>
                        <span class="payment-detail-value" :class="hasEnoughBalance ? 'success' : 'warning'">
                            ¥{{ Number(availableBalance || 0).toFixed(2) }}
                        </span>
                    </div>
                    <div class="payment-detail-item" v-if="!hasEnoughBalance">
                        <span class="payment-detail-label">还需充值</span>
                        <span class="payment-detail-value warning">¥{{ Number(needRecharge || 0).toFixed(2) }}</span>
                    </div>
                </div>
                
                <!-- 余额不足警告 -->
                <div class="balance-warning-box" v-if="!hasEnoughBalance">
                    <h4>
                        <i class="el-icon-warning" style="color: #E6A23C;"></i>
                        保证金余额不足
                    </h4>
                    <p>
                        您的可用保证金为 <strong>¥{{ Number(availableBalance || 0).toFixed(2) }}</strong>，<br>
                        支付金额需要 <strong>¥{{ actualPayAmount.toFixed(2) }}</strong>
                        <span v-if="actualShippingFee > 0">（尾款 + 物流费）</span>，<br>
                        还需充值 <strong>¥{{ Number(needRecharge || 0).toFixed(2) }}</strong> 才能完成支付。
                    </p>
                    <div style="margin-top: 15px;">
                        <el-button type="warning" @click="goToRecharge" style="width: 100%;">
                            立即充值 ¥{{ Number(needRecharge || 0).toFixed(2) }}
                        </el-button>
                    </div>
                </div>
                
                <!-- 支付说明 -->
                <el-alert 
                    title="支付方式：保证金账户" 
                    type="info" 
                    :closable="false"
                    style="margin-bottom: 20px;">
                    <template #default>
                        <p style="margin: 0; font-size: 13px; line-height: 1.6;">
                            • 保证金将自动抵扣订单金额<br>
                            • 尾款从您的可用保证金余额中扣除<br>
                            • 支付成功后订单立即生效
                        </p>
                    </template>
                </el-alert>
                
                <!-- 操作按钮 -->
                <div style="text-align: center; margin-top: 20px;">
                    <el-button @click="paymentDialogVisible = false" size="large">取消</el-button>
                    <el-button 
                        type="primary" 
                        @click="processPayment"
                        :disabled="!hasEnoughBalance"
                        :loading="paying"
                        size="large">
                        {{ hasEnoughBalance ? '确认支付' : '余额不足，请先充值' }}
                    </el-button>
                </div>
            </div>
        </el-dialog>
    </div>

    <!-- Element UI JS - 使用CDN -->
    <script src="/js/vue.js"></script>
    <script src="/js/element-plus.js"></script>
    <script src="/js/axios.js"></script>
    
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    loading: false,
                    isLoggedIn: false,
                    userInfo: {},
                    unreadNotifications: 0,
                    searchKeyword: '',
                    statusFilter: '',
                    dateRange: null,
                    orders: [],
                    currentPage: 1,
                    pageSize: 10,
                    totalCount: 0,
                    paymentDialogVisible: false,
                    currentOrder: null,
                    selectedPaymentMethod: '',
                    paying: false,
                    // 保证金账户信息
                    availableBalance: 0,
                    frozenBalance: 0,
                    // 配送信息
                    deliveryMethod: 1, // 1-物流配送，2-线下自提
                    shippingFee: 15, // 默认物流费用15元
                    receiverInfo: {
                        name: '',
                        phone: '',
                        address: ''
                    },
                    // 地址管理
                    savedAddresses: [], // 保存的地址列表
                    selectedAddressId: 0, // 选中的地址ID，0表示手动输入
                    // 物流公司管理
                    logisticsCompanies: [], // 物流公司列表
                    selectedLogisticsCompanyId: null, // 选中的物流公司ID
                    // 拍卖会信息
                    sessionCommissionRate: 0, // 拍卖会佣金比例
                    sessionIsFreeShipping: 0, // 拍卖会是否包邮
                    commissionFee: 0 // 佣金费用
                }
            },
            computed: {
                filteredOrders() {
                    let filtered = this.orders;
                    
                    if (this.searchKeyword) {
                        filtered = filtered.filter(order => 
                            order.orderNumber.toLowerCase().includes(this.searchKeyword.toLowerCase()) ||
                            order.itemName.toLowerCase().includes(this.searchKeyword.toLowerCase())
                        );
                    }
                    
                    if (this.statusFilter) {
                        filtered = filtered.filter(order => order.status === this.statusFilter);
                    }
                    
                    if (this.dateRange && this.dateRange.length === 2) {
                        const startDate = new Date(this.dateRange[0]);
                        const endDate = new Date(this.dateRange[1]);
                        filtered = filtered.filter(order => {
                            const orderDate = new Date(order.createTime);
                            return orderDate >= startDate && orderDate <= endDate;
                        });
                    }
                    
                    return filtered;
                },
                totalPages() {
                    return Math.ceil(this.totalCount / this.pageSize);
                },
                // 计算实际物流费（如果包邮则为0）
                actualShippingFee() {
                    if (!this.currentOrder) return 0;
                    // 如果是线下自提，物流费为0
                    if (this.deliveryMethod === 2) return 0;
                    
                    // 检查拍卖会是否包邮（从拍卖会表的isFreeShipping字段读取）
                    if (this.sessionIsFreeShipping === 1) return 0;
                    
                    // 如果选择了物流公司，使用物流公司计算的费用
                    if (this.selectedLogisticsCompanyId && this.deliveryMethod === 1) {
                        const company = this.logisticsCompanies.find(c => c.id === this.selectedLogisticsCompanyId);
                        if (company) {
                            return this.calculateCompanyFee(company);
                        }
                    }
                    
                    // 如果没有选择物流公司，返回0（等待用户选择）
                    return 0;
                },
                // 计算实际需要支付的金额（尾款 + 物流费）
                actualPayAmount() {
                    if (!this.currentOrder) return 0;
                    const balance = Number(this.currentOrder.balanceAmount || 0);
                    return balance + this.actualShippingFee;
                },
                // 检查保证金余额是否足够（包含物流费）
                hasEnoughBalance() {
                    return this.availableBalance >= this.actualPayAmount;
                },
                // 计算还需充值的金额（包含物流费）
                needRecharge() {
                    const shortage = this.actualPayAmount - this.availableBalance;
                    return Math.max(0, shortage);
                }
            },
            mounted() {
                this.setupAxiosInterceptors();
                this.checkLoginStatus();
                if (this.isLoggedIn) {
                    this.loadOrders();
                    this.loadDepositBalance();
                    this.loadUnreadNotifications();
                    // 每30秒刷新未读通知数
                    setInterval(() => {
                        if (this.isLoggedIn) {
                            this.loadUnreadNotifications();
                        }
                    }, 30000);
                }
            },
            methods: {
                // 设置axios拦截器
                setupAxiosInterceptors() {
                    // 请求拦截器 - 自动添加Authorization头
                    axios.interceptors.request.use(
                        config => {
                            const token = localStorage.getItem('accessToken');
                            if (token) {
                                config.headers.Authorization = `Bearer ${token}`;
                            }
                            return config;
                        },
                        error => {
                            return Promise.reject(error);
                        }
                    );
                    
                    // 响应拦截器 - 处理401错误
                    axios.interceptors.response.use(
                        response => response,
                        async error => {
                            if (error.response && error.response.status === 401) {
                                // 尝试刷新Token
                                const refreshToken = localStorage.getItem('refreshToken');
                                if (refreshToken) {
                                    try {
                                        const response = await axios.post('/api/auth/refresh', {
                                            refreshToken: refreshToken
                                        });
                                        
                                        if (response.data.code === 200) {
                                            const newAccessToken = response.data.data.accessToken;
                                            localStorage.setItem('accessToken', newAccessToken);
                                            error.config.headers.Authorization = `Bearer ${newAccessToken}`;
                                            return axios.request(error.config);
                                        }
                                    } catch (refreshError) {
                                        console.error('Token刷新失败:', refreshError);
                                    }
                                }
                                
                                // 刷新失败，清除token并跳转
                                localStorage.removeItem('accessToken');
                                localStorage.removeItem('refreshToken');
                                localStorage.removeItem('userInfo');
                                this.isLoggedIn = false;
                                this.userInfo = {};
                                ElMessage.error('登录已过期，请重新登录');
                                window.location.href = '/auction/login';
                            }
                            return Promise.reject(error);
                        }
                    );
                },
                
                // 检查登录状态
                checkLoginStatus() {
                    const accessToken = localStorage.getItem('accessToken');
                    const refreshToken = localStorage.getItem('refreshToken');
                    const userInfoStr = localStorage.getItem('userInfo');
                    
                    if (accessToken && refreshToken) {
                        this.isLoggedIn = true;
                        if (userInfoStr) {
                            this.userInfo = JSON.parse(userInfoStr);
                        } else {
                            this.userInfo = {
                                username: 'buyer1',
                                nickname: '买家1'
                            };
                        }
                    } else {
                        // 未登录，跳转到登录页
                        this.isLoggedIn = false;
                        ElMessage.warning('请先登录');
                        window.location.href = '/auction/login';
                    }
                },
                
                // 加载订单列表
                loadOrders() {
                    this.loading = true;
                    axios.get('/api/user/orders', {
                        params: {
                            page: this.currentPage,
                            size: this.pageSize
                        }
                    })
                    .then(response => {
                        console.log('订单接口返回:', response.data);
                        if (response.data.code === 200) {
                            // 后端返回的数据结构是 data.data.data
                            const result = response.data.data;
                            this.orders = result.data || [];
                            this.totalCount = result.total || 0;
                            console.log('订单列表:', this.orders);
                            console.log('订单总数:', this.totalCount);
                        } else {
                            ElMessage.error(response.data.message || '加载订单列表失败');
                        }
                    })
                    .catch(error => {
                        console.error('加载订单列表错误:', error);
                        ElMessage.error('加载订单列表失败');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
                },
                
                // 搜索
                handleSearch() {
                    // 搜索逻辑在 computed 中处理
                },
                
                // 筛选
                handleFilter() {
                    // 筛选逻辑在 computed 中处理
                },
                
                // 重置筛选
                resetFilter() {
                    this.searchKeyword = '';
                    this.statusFilter = '';
                    this.dateRange = null;
                },
                
                // 分页
                handlePageChange(page) {
                    this.currentPage = page;
                    this.loadOrders();
                },
                
                // 获取状态样式类
                getStatusClass(status) {
                    // 支持数字和字符串两种格式
                    const statusMap = {
                        1: 'status-pending',
                        2: 'status-paid',
                        3: 'status-shipped',
                        4: 'status-delivered',
                        5: 'status-delivered',
                        6: 'status-cancelled',
                        'pending': 'status-pending',
                        'paid': 'status-paid',
                        'shipped': 'status-shipped',
                        'delivered': 'status-delivered',
                        'cancelled': 'status-cancelled'
                    };
                    return statusMap[status] || 'status-pending';
                },
                
                // 获取状态文本
                getStatusText(status) {
                    // 支持数字和字符串两种格式
                    const statusMap = {
                        1: '待支付',
                        2: '已支付',
                        3: '已发货',
                        4: '已收货',
                        5: '已完成',
                        6: '已取消',
                        'pending': '待支付',
                        'paid': '已支付',
                        'shipped': '已发货',
                        'delivered': '已收货',
                        'cancelled': '已取消'
                    };
                    return statusMap[status] || status;
                },
                
                // 格式化时间
                formatTime(time) {
                    return new Date(time).toLocaleString('zh-CN');
                },
                
                // 加载保证金余额
                loadDepositBalance() {
                    axios.get('/api/deposit/account')
                        .then(response => {
                            if (response.data.code === 200) {
                                const data = response.data.data;
                                this.availableBalance = Number(data.availableAmount || 0);
                                this.frozenBalance = Number(data.frozenAmount || 0);
                            }
                        })
                        .catch(error => {
                            console.error('加载保证金余额失败:', error);
                        });
                },
                
                // 加载地址列表
                loadAddresses() {
                    axios.get('/api/user/addresses/list')
                        .then(response => {
                            if (response.data.code === 200) {
                                this.savedAddresses = response.data.data || [];
                                // 如果有默认地址，自动选中
                                const defaultAddr = this.savedAddresses.find(addr => addr.isDefault === 1);
                                if (defaultAddr) {
                                    this.selectedAddressId = defaultAddr.id;
                                    this.onAddressSelect(defaultAddr.id);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('加载地址列表失败:', error);
                        });
                },
                
                // 加载物流公司列表
                loadLogisticsCompanies() {
                    axios.get('/api/user/logistics-companies')
                        .then(response => {
                            if (response.data.code === 200) {
                                this.logisticsCompanies = response.data.data || [];
                                // 如果有物流公司，默认选择第一个
                                if (this.logisticsCompanies.length > 0) {
                                    this.selectedLogisticsCompanyId = this.logisticsCompanies[0].id;
                                }
                            }
                        })
                        .catch(error => {
                            console.error('加载物流公司列表失败:', error);
                        });
                },
                
                // 计算物流公司费用
                calculateCompanyFee(company) {
                    if (!company || !this.currentOrder) return 0;
                    
                    const orderAmount = Number(this.currentOrder.totalAmount || 0);
                    const baseFee = Number(company.baseFee || 0);
                    const insuranceRate = Number(company.insuranceRate || 0);
                    
                    // 保价费用 = 订单金额 * 保价费率 / 100
                    const insuranceFee = orderAmount * insuranceRate / 100;
                    
                    // 总费用 = 基础运费 + 保价费用
                    return baseFee + insuranceFee;
                },
                
                // 配送方式改变
                onDeliveryMethodChange() {
                    // 重置物流公司选择
                    this.selectedLogisticsCompanyId = null;
                    if (this.deliveryMethod === 1 && this.logisticsCompanies.length > 0) {
                        this.selectedLogisticsCompanyId = this.logisticsCompanies[0].id;
                    }
                },
                
                // 物流公司改变
                onLogisticsCompanyChange() {
                    // 物流公司改变时，费用会自动重新计算
                    console.log('物流公司改变:', this.selectedLogisticsCompanyId);
                },
                
                // 选择地址
                onAddressSelect(addressId) {
                    if (addressId === 0) {
                        // 手动输入，清空收货信息
                        this.receiverInfo = { name: '', phone: '', address: '' };
                        return;
                    }
                    
                    const addr = this.savedAddresses.find(a => a.id === addressId);
                    if (addr) {
                        this.receiverInfo.name = addr.receiverName;
                        this.receiverInfo.phone = addr.receiverPhone;
                        this.receiverInfo.address = addr.fullAddress;
                    }
                },
                
                // 跳转到地址管理页面
                goToAddressManage() {
                    window.location.href = '/auction/user/addresses';
                },
                
                // 显示支付对话框
                async showPaymentDialog(order) {
                    this.currentOrder = order;
                    this.selectedPaymentMethod = '';
                    // 重置配送信息
                    this.deliveryMethod = 1;
                    this.receiverInfo = { name: '', phone: '', address: '' };
                    this.selectedAddressId = 0;
                    this.selectedLogisticsCompanyId = null;
                    
                    // 加载拍卖会信息以获取佣金比例和包邮信息
                    try {
                        const sessionResponse = await axios.get(`/api/user/sessions/${order.sessionId}`);
                        if (sessionResponse.data.code === 200) {
                            const sessionData = sessionResponse.data.data;
                            this.sessionCommissionRate = Number(sessionData.commissionRatio || 0);
                            this.sessionIsFreeShipping = sessionData.isFreeShipping || 0;
                            
                            // 计算佣金费用 = 成交价 × 佣金比例（commissionRatio已经是小数，如0.05代表5%）
                            this.commissionFee = Number(order.totalAmount || 0) * this.sessionCommissionRate;
                        }
                    } catch (e) {
                        console.error('加载拍卖会信息失败:', e);
                        // 使用默认值
                        this.sessionCommissionRate = 0;
                        this.sessionIsFreeShipping = 0;
                        this.commissionFee = 0;
                    }
                    
                    // 刷新保证金余额
                    this.loadDepositBalance();
                    // 加载地址列表
                    this.loadAddresses();
                    // 加载物流公司列表
                    this.loadLogisticsCompanies();
                    this.paymentDialogVisible = true;
                },
                
                // 处理支付
                processPayment() {
                    // 检查余额是否足够
                    if (!this.hasEnoughBalance) {
                        ElMessage.warning('保证金余额不足，请先充值');
                        return;
                    }
                    
                    // 如果选择物流配送，验证收货信息和物流公司
                    if (this.deliveryMethod === 1) {
                        if (!this.receiverInfo.name || !this.receiverInfo.phone || !this.receiverInfo.address) {
                            ElMessage.error('请填写完整的收货信息');
                            return;
                        }
                        // 验证手机号格式
                        const phoneReg = /^1[3-9]\d{9}$/;
                        if (!phoneReg.test(this.receiverInfo.phone)) {
                            ElMessage.error('请输入正确的手机号');
                            return;
                        }
                        // 验证是否选择了物流公司（非包邮情况下）
                        const isFreeShipping = this.currentOrder.item?.isFreeShipping || this.currentOrder.isFreeShipping;
                        if (!isFreeShipping && !this.selectedLogisticsCompanyId) {
                            ElMessage.error('请选择物流公司');
                            return;
                        }
                    }
                    
                    // 构建确认信息
                    let confirmMsg = `确认支付订单？<br><br>` +
                        `订单总额：¥${Number(this.currentOrder.totalAmount || 0).toFixed(2)}<br>` +
                        `保证金抵扣：-¥${Number(this.currentOrder.depositAmount || 0).toFixed(2)}<br>` +
                        `商品尾款：¥${Number(this.currentOrder.balanceAmount || 0).toFixed(2)}<br>`;
                    
                    if (this.actualShippingFee > 0) {
                        confirmMsg += `物流费用：+¥${this.actualShippingFee.toFixed(2)}<br>`;
                    }
                    
                    confirmMsg += `<strong style="color: #F56C6C;">实付金额：¥${this.actualPayAmount.toFixed(2)}</strong><br><br>`;
                    
                    if (this.deliveryMethod === 1) {
                        confirmMsg += `📦 配送方式：物流配送<br>`;
                        confirmMsg += `📍 收货地址：${this.receiverInfo.address}<br>`;
                    } else {
                        confirmMsg += `📦 配送方式：线下自提<br>`;
                    }
                    
                    confirmMsg += `<br><strong style="color: #E6A23C;">支付后将从您的保证金账户扣款</strong>`;
                    
                    // 二次确认
                    ElMessageBox.confirm(confirmMsg, '确认支付', {
                        confirmButtonText: '确认支付',
                        cancelButtonText: '取消',
                        type: 'warning',
                        dangerouslyUseHTMLString: true
                    }).then(() => {
                        this.paying = true;
                        const paymentData = {
                            orderId: this.currentOrder.id,
                            paymentMethod: 'deposit',
                            deliveryMethod: this.deliveryMethod,
                            shippingFee: this.actualShippingFee,
                            logisticsCompanyId: this.selectedLogisticsCompanyId,
                            receiverName: this.receiverInfo.name,
                            receiverPhone: this.receiverInfo.phone,
                            receiverAddress: this.receiverInfo.address
                        };
                        
                        axios.post('/api/user/orders/pay', paymentData)
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success('支付成功');
                                    this.paymentDialogVisible = false;
                                    this.loadOrders();
                                    this.loadDepositBalance();
                                } else {
                                    ElMessage.error(response.data.message || '支付失败');
                                }
                            })
                            .catch(error => {
                                console.error('支付错误:', error);
                                ElMessage.error(error.response?.data?.message || '支付失败，请稍后重试');
                            })
                            .finally(() => {
                                this.paying = false;
                            });
                    }).catch(() => {
                        // 用户取消
                    });
                },
                
                // 跳转到充值页面
                goToRecharge() {
                    this.paymentDialogVisible = false;
                    window.location.href = '/auction/user/deposits';
                },
                
                // 取消订单
                cancelOrder(order) {
                    ElMessageBox.confirm('确定要取消这个订单吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        axios.post(`/api/user/orders/${order.id}/cancel`)
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success('订单已取消');
                                    this.loadOrders();
                                } else {
                                    ElMessage.error(response.data.message || '取消失败');
                                }
                            })
                            .catch(error => {
                                console.error('取消订单错误:', error);
                                ElMessage.error('取消失败，请稍后重试');
                            });
                    });
                },
                
                // 确认收货
                confirmReceive(order) {
                    ElMessageBox.confirm('确定已收到商品吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        axios.post(`/api/user/orders/${order.id}/confirm`)
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success('确认收货成功');
                                    this.loadOrders();
                                } else {
                                    ElMessage.error(response.data.message || '确认收货失败');
                                }
                            })
                            .catch(error => {
                                console.error('确认收货错误:', error);
                                ElMessage.error('确认收货失败，请稍后重试');
                            });
                    });
                },
                
                
                // 跳转到登录页面
                async loadUnreadNotifications() {
                    try {
                        const response = await axios.get('/api/notifications/unread-count');
                        if (response.data.code === 200) {
                            this.unreadNotifications = response.data.data;
                        }
                    } catch (error) {
                        console.error('获取未读通知数失败:', error);
                    }
                },
                
                goToNotifications() {
                    window.location.href = '/auction/user/notifications';
                },
                
                goToLogin() {
                    window.location.href = '/auction/login';
                },
                
                // 退出登录
                logout() {
                    ElMessageBox.confirm('确定要退出登录吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userInfo');
                        axios.post('/api/auth/logout').finally(() => {
                            this.isLoggedIn = false;
                            this.userInfo = {};
                            ElMessage.success('已退出登录');
                            window.location.reload();
                        });
                    });
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
    
</body>
</html>

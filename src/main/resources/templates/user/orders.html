<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è®¢å• - æ‹å–ç³»ç»Ÿ</title>
    
    <!-- Element UI CSS - ä½¿ç”¨CDN -->
    <link rel="stylesheet" href="/css/element-plus.css">
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'å¾®è½¯é›…é»‘', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 28px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #303133;
            margin: 0;
        }
        
        .page-description {
            color: #606266;
            margin: 10px 0 0 0;
        }
        
        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .order-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .order-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 20px;
            transition: all 0.3s;
        }
        
        .order-item:hover {
            background: #f8f9fa;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .order-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .order-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .order-details h4 {
            margin: 0 0 5px 0;
            color: #303133;
            font-size: 16px;
        }
        
        .order-details p {
            margin: 0;
            color: #606266;
            font-size: 14px;
        }
        
        .order-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-paid {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-shipped {
            background: #e1f5fe;
            color: #0277bd;
        }
        
        .status-delivered {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status-cancelled {
            background: #ffebee;
            color: #c62828;
        }
        
        .order-amount {
            text-align: right;
            margin-bottom: 15px;
        }
        
        .amount-label {
            font-size: 14px;
            color: #909399;
            margin-bottom: 5px;
        }
        
        .amount-value {
            font-size: 20px;
            font-weight: bold;
            color: #f56c6c;
        }
        
        .order-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .action-btn {
            min-width: 80px;
        }
        
        .order-timeline {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .timeline-title {
            font-size: 14px;
            color: #606266;
            margin-bottom: 10px;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .timeline-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #409EFF;
            margin-right: 10px;
        }
        
        .timeline-content {
            font-size: 14px;
            color: #606266;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .pagination {
            text-align: center;
            margin-top: 30px;
        }
        
        .payment-dialog {
            max-width: 500px;
        }
        
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .payment-method {
            border: 2px solid #e4e7ed;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-method:hover {
            border-color: #409EFF;
        }
        
        .payment-method.selected {
            border-color: #409EFF;
            background: #f0f9ff;
        }
        
        .payment-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .payment-name {
            font-size: 14px;
            font-weight: bold;
        }
        
        /* è®¢å•è¯¦æƒ…å¯¹è¯æ¡†æ ·å¼ */
        .order-detail-content {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .detail-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        .detail-section h4 {
            font-size: 16px;
            font-weight: bold;
            color: #303133;
            margin: 0 0 15px 0;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
        }
        
        .detail-label {
            font-weight: bold;
            color: #606266;
            min-width: 100px;
        }
        
        .detail-value {
            color: #303133;
        }
        
        .item-info {
            display: flex;
            gap: 15px;
        }
        
        .item-image {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-details h5 {
            font-size: 16px;
            font-weight: bold;
            color: #303133;
            margin: 0 0 10px 0;
        }
        
        .item-description {
            color: #606266;
            font-size: 14px;
            line-height: 1.5;
            margin: 0 0 15px 0;
        }
        
        .item-meta {
            display: flex;
            gap: 20px;
        }
        
        .meta-item {
            font-size: 14px;
            color: #909399;
        }
        
        .cost-breakdown {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .cost-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .cost-item.total {
            border-top: 1px solid #e4e7ed;
            margin-top: 10px;
            padding-top: 15px;
            font-weight: bold;
        }
        
        .cost-label {
            color: #606266;
        }
        
        .cost-value {
            font-weight: bold;
        }
        
        .cost-value.success {
            color: #67c23a;
        }
        
        .cost-value.warning {
            color: #e6a23c;
        }
        
        .cost-value.highlight {
            color: #409eff;
            font-size: 16px;
        }
        
        .delivery-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        
        .delivery-method {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e4e7ed;
        }
        
        /* ç‰©æµå…¬å¸é€‰æ‹©æ ·å¼ */
        .logistics-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e4e7ed;
        }
        
        .logistics-title {
            margin: 0 0 20px 0;
            font-size: 16px;
            font-weight: bold;
            color: #303133;
            display: flex;
            align-items: center;
        }
        
        .logistics-title::before {
            content: "ğŸšš";
            margin-right: 8px;
            font-size: 18px;
        }
        
        .logistics-companies {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .logistics-company-item {
            width: 100%;
        }
        
        .logistics-radio {
            width: 100%;
            margin: 0;
            padding: 0;
            border: none;
        }
        
        .logistics-radio .el-radio__input {
            display: none;
        }
        
        .logistics-radio .el-radio__label {
            width: 100%;
            padding: 0;
            margin: 0;
        }
        
        .logistics-company-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border: 2px solid #e4e7ed;
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .logistics-company-content:hover {
            border-color: #409EFF;
            box-shadow: 0 2px 8px rgba(64, 158, 255, 0.1);
        }
        
        .logistics-radio.is-checked .logistics-company-content {
            border-color: #409EFF;
            background: #f0f9ff;
            box-shadow: 0 2px 8px rgba(64, 158, 255, 0.15);
        }
        
        .company-info {
            flex: 1;
            margin-right: 20px;
        }
        
        .company-name {
            font-size: 16px;
            font-weight: bold;
            color: #303133;
            margin-bottom: 10px;
        }
        
        .company-details {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #606266;
        }
        
        .detail-item i {
            margin-right: 6px;
            color: #909399;
            font-size: 14px;
        }
        
        .company-fee {
            text-align: right;
            min-width: 120px;
        }
        
        .fee-label {
            font-size: 12px;
            color: #909399;
            margin-bottom: 5px;
        }
        
        .fee-amount {
            font-size: 18px;
            font-weight: bold;
            color: #f56c6c;
        }
        
        .payment-detail-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .payment-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e4e7ed;
        }
        
        .payment-detail-item:last-child {
            border-bottom: none;
            padding-top: 15px;
            margin-top: 5px;
            border-top: 2px dashed #e4e7ed;
        }
        
        .payment-detail-label {
            font-size: 14px;
            color: #606266;
        }
        
        .payment-detail-value {
            font-size: 16px;
            font-weight: bold;
            color: #303133;
        }
        
        .payment-detail-value.highlight {
            color: #f56c6c;
            font-size: 20px;
        }
        
        .payment-detail-value.success {
            color: #67C23A;
        }
        
        .payment-detail-value.warning {
            color: #E6A23C;
        }
        
        .balance-warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .balance-warning-box h4 {
            margin: 0 0 10px 0;
            color: #856404;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .balance-warning-box p {
            margin: 0;
            color: #856404;
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <el-header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="el-icon-gavel"></i>
                    <span>æ‹å–ç³»ç»Ÿ</span>
                </div>
                <div class="nav-links">
                    
                    <el-link href="/auction/user/sessions" :underline="false">æ‹å–ä¼š</el-link>
                    <el-link :underline="false" disabled style="font-weight: bold; color: #409EFF; cursor: not-allowed;">æˆ‘çš„è®¢å•</el-link>
                    <el-link href="/auction/user/deposits" :underline="false">ä¿è¯é‡‘</el-link>
                    <el-link href="/auction/user/addresses" :underline="false">æ”¶è´§åœ°å€</el-link>
                    <el-link href="/auction/user/notifications" :underline="false">æˆ‘çš„é€šçŸ¥</el-link>
                </div>
                <div class="user-info" v-if="isLoggedIn">
                    <el-badge :value="unreadNotifications" :hidden="unreadNotifications === 0" style="margin-right: 15px;">
                        <el-button icon="el-icon-bell" circle @click="goToNotifications"></el-button>
                    </el-badge>
                    <span>æ¬¢è¿ï¼Œ{{ userInfo.nickname || userInfo.username }}</span>
                    <el-button @click="logout" type="danger" size="small">é€€å‡ºç™»å½•</el-button>
                </div>
                <div class="user-info" v-else>
                    <el-button @click="goToLogin" type="primary" size="small">ç™»å½•</el-button>
                </div>
            </div>
        </el-header>

        <!-- ä¸»è¦å†…å®¹ -->
        <el-main class="main-content">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="page-header">
                <h1 class="page-title">æˆ‘çš„è®¢å•</h1>
                <p class="page-description">æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„æ‹å–è®¢å•</p>
            </div>

            <!-- ç­›é€‰æ¡ä»¶ -->
            <div class="filter-section">
                <el-row :gutter="20">
                    <el-col :span="6">
                        <el-input 
                            v-model="searchKeyword" 
                            placeholder="æœç´¢è®¢å•å·æˆ–æ‹å“åç§°"
                            @input="handleSearch"
                            clearable>
                            <template #prefix>
                                <i class="el-icon-search"></i>
                            </template>
                        </el-input>
                    </el-col>
                    <el-col :span="4">
                        <el-select 
                            v-model="statusFilter" 
                            placeholder="çŠ¶æ€ç­›é€‰"
                            @change="handleFilter"
                            clearable>
                            <el-option label="å¾…æ”¯ä»˜" value="pending"></el-option>
                            <el-option label="å·²æ”¯ä»˜" value="paid"></el-option>
                            <el-option label="å·²å‘è´§" value="shipped"></el-option>
                            <el-option label="å·²æ”¶è´§" value="delivered"></el-option>
                            <el-option label="å·²å–æ¶ˆ" value="cancelled"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="4">
                        <el-date-picker 
                            v-model="dateRange" 
                            type="daterange" 
                            range-separator="è‡³"
                            start-placeholder="å¼€å§‹æ—¥æœŸ"
                            end-placeholder="ç»“æŸæ—¥æœŸ"
                            @change="handleFilter">
                        </el-date-picker>
                    </el-col>
                    <el-col :span="4">
                        <el-button @click="resetFilter" type="info">é‡ç½®ç­›é€‰</el-button>
                    </el-col>
                </el-row>
            </div>

            <!-- è®¢å•åˆ—è¡¨ -->
            <div class="order-list">
                <div v-if="loading" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading"><Loading /></el-icon>
                    <p>åŠ è½½ä¸­...</p>
                </div>
                
                <div v-else-if="filteredOrders.length === 0" class="empty-state">
                    <i class="el-icon-document empty-icon"></i>
                    <h3>æš‚æ— è®¢å•</h3>
                    <p>æ‚¨è¿˜æ²¡æœ‰ä»»ä½•è®¢å•è®°å½•</p>
                </div>
                
                <div v-else>
                    <div 
                        v-for="order in filteredOrders" 
                        :key="order.id" 
                        class="order-item">
                        
                        <div class="order-header">
                            <div class="order-info">
                                <img :src="order.itemImage || '/images/default-item.jpg'" :alt="order.itemName" class="order-image">
                                <div class="order-details">
                                    <h4>{{ order.itemName }}</h4>
                                    <p>è®¢å•å·: {{ order.orderNumber }}</p>
                                    <p>æˆäº¤æ—¶é—´: {{ formatTime(order.createTime) }}</p>
                                </div>
                            </div>
                            <div class="order-status" :class="getStatusClass(order.status)">
                                {{ getStatusText(order.status) }}
                            </div>
                        </div>
                        
                        <div class="order-amount">
                            <div class="amount-label">æˆäº¤é‡‘é¢</div>
                            <div class="amount-value">Â¥{{ Number(order.totalAmount || 0).toFixed(2) }}</div>
                        </div>
                        
                        <div class="order-actions">
                            <el-button 
                                type="info" 
                                @click="showOrderDetail(order)"
                                class="action-btn">
                                æŸ¥çœ‹è¯¦æƒ…
                            </el-button>
                            <el-button 
                                v-if="order.status === 1 || order.status === 'pending'"
                                type="primary" 
                                @click="showPaymentDialog(order)"
                                class="action-btn">
                                ç«‹å³æ”¯ä»˜
                            </el-button>
                            <el-button 
                                v-if="order.status === 1 || order.status === 'pending'"
                                type="danger" 
                                @click="cancelOrder(order)"
                                class="action-btn">
                                å–æ¶ˆè®¢å•
                            </el-button>
                            <el-button 
                                v-if="order.status === 3 || order.status === 'shipped'"
                                type="success" 
                                @click="confirmReceive(order)"
                                class="action-btn">
                                ç¡®è®¤æ”¶è´§
                            </el-button>
                        </div>
                        
                        <div class="order-timeline" v-if="order.timeline && order.timeline.length > 0">
                            <div class="timeline-title">è®¢å•è¿›åº¦</div>
                            <div 
                                v-for="event in order.timeline" 
                                :key="event.id" 
                                class="timeline-item">
                                <div class="timeline-dot"></div>
                                <div class="timeline-content">
                                    {{ event.description }} - {{ formatTime(event.createTime) }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åˆ†é¡µ -->
            <div class="pagination" v-if="totalPages > 1">
                <el-pagination
                    v-model:current-page="currentPage"
                    :page-size="pageSize"
                    :total="totalCount"
                    layout="prev, pager, next, jumper"
                    @current-change="handlePageChange">
                </el-pagination>
            </div>
        </el-main>

        <!-- æ”¯ä»˜å¯¹è¯æ¡† -->
        <el-dialog 
            v-model="paymentDialogVisible" 
            title="è®¢å•æ”¯ä»˜" 
            width="600px"
            class="payment-dialog">
            <div v-if="currentOrder">
                <!-- è®¢å•ä¿¡æ¯ -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 10px 0;">{{ currentOrder.itemName }}</h3>
                    <p style="color: #909399; font-size: 13px; margin: 0;">è®¢å•å·: {{ currentOrder.orderNo }}</p>
                </div>
                
                <!-- é…é€æ–¹å¼é€‰æ‹© -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin: 0 0 15px 0; font-size: 16px; color: #303133;">é€‰æ‹©é…é€æ–¹å¼</h4>
                    <el-radio-group v-model="deliveryMethod" size="large" @change="onDeliveryMethodChange">
                        <el-radio :label="1" border style="margin-right: 15px;">
                            <i class="el-icon-truck"></i> ç‰©æµé…é€
                            <span v-if="sessionIsFreeShipping === 1" style="color: #67C23A; font-size: 12px; margin-left: 5px;">
                                ï¼ˆåŒ…é‚® å…è¿è´¹ï¼‰
                            </span>
                            <span v-else style="color: #E6A23C; font-size: 12px; margin-left: 5px;">
                                ï¼ˆ+Â¥{{ actualShippingFee.toFixed(2) }}ï¼‰
                            </span>
                        </el-radio>
                        <el-radio :label="2" border>
                            <i class="el-icon-place"></i> çº¿ä¸‹è‡ªæ
                            <span style="color: #67C23A; font-size: 12px; margin-left: 5px;">ï¼ˆå…è¿è´¹ï¼‰</span>
                        </el-radio>
                    </el-radio-group>
                </div>
                
                <!-- ç‰©æµå…¬å¸é€‰æ‹©ï¼ˆç‰©æµé…é€æ—¶æ˜¾ç¤ºä¸”éåŒ…é‚®ï¼‰ -->
                <div v-if="deliveryMethod === 1 && sessionIsFreeShipping !== 1" class="logistics-section">
                    <h4 class="logistics-title">é€‰æ‹©ç‰©æµå…¬å¸</h4>
                    <div class="logistics-companies">
                        <div 
                            v-for="company in logisticsCompanies" 
                            :key="company.id"
                            class="logistics-company-item">
                            <el-radio 
                                :label="company.id" 
                                border 
                                class="logistics-radio"
                                @change="onLogisticsCompanyChange">
                                <div class="logistics-company-content">
                                    <div class="company-info">
                                        <div class="company-name">
                                            {{ company.companyName }}
                                        </div>
                                        <div class="company-details">
                                            <span class="detail-item">
                                                <i class="el-icon-truck"></i>
                                                åŸºç¡€è¿è´¹ï¼šÂ¥{{ company.baseFee }}
                                            </span>
                                            <span class="detail-item">
                                                <i class="el-icon-shield"></i>
                                                ä¿ä»·è´¹ç‡ï¼š{{ company.insuranceRate }}%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="company-fee">
                                        <div class="fee-label">é¢„è®¡è´¹ç”¨</div>
                                        <div class="fee-amount">Â¥{{ calculateCompanyFee(company).toFixed(2) }}</div>
                                    </div>
                                </div>
                            </el-radio>
                        </div>
                    </div>
                </div>
                
                <!-- æ”¶è´§åœ°å€ï¼ˆç‰©æµé…é€æ—¶æ˜¾ç¤ºï¼‰ -->
                <div v-if="deliveryMethod === 1" style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; font-size: 16px; color: #303133;">æ”¶è´§ä¿¡æ¯</h4>
                        <el-button 
                            text 
                            type="primary" 
                            @click="goToAddressManage"
                            style="font-size: 13px;">
                            <i class="el-icon-setting"></i> ç®¡ç†åœ°å€
                        </el-button>
                    </div>
                    
                    <!-- åœ°å€é€‰æ‹©å™¨ -->
                    <div v-if="savedAddresses.length > 0" style="margin-bottom: 15px;">
                        <el-radio-group v-model="selectedAddressId" @change="onAddressSelect" style="width: 100%;">
                            <div 
                                v-for="addr in savedAddresses" 
                                :key="addr.id"
                                style="margin-bottom: 10px;">
                                <el-radio :label="addr.id" border style="width: 100%; padding: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; margin-bottom: 5px;">
                                                {{ addr.receiverName }} {{ addr.receiverPhone }}
                                                <el-tag v-if="addr.isDefault === 1" size="small" type="primary" style="margin-left: 8px;">é»˜è®¤</el-tag>
                                                <el-tag v-if="addr.tag" size="small" style="margin-left: 8px;">{{ addr.tag }}</el-tag>
                                            </div>
                                            <div style="color: #909399; font-size: 13px;">{{ addr.fullAddress }}</div>
                                        </div>
                                    </div>
                                </el-radio>
                            </div>
                        </el-radio-group>
                    </div>
                    
                    <!-- æ‰‹åŠ¨è¾“å…¥é€‰é¡¹ -->
                    <el-collapse-transition>
                        <div v-show="selectedAddressId === 0 || savedAddresses.length === 0">
                            <el-divider v-if="savedAddresses.length > 0" content-position="center">
                                <el-button text @click="selectedAddressId = 0">æˆ–æ‰‹åŠ¨è¾“å…¥åœ°å€</el-button>
                            </el-divider>
                            <el-form :model="receiverInfo" label-width="80px" size="default">
                                <el-form-item label="æ”¶è´§äºº" required>
                                    <el-input v-model="receiverInfo.name" placeholder="è¯·è¾“å…¥æ”¶è´§äººå§“å"></el-input>
                                </el-form-item>
                                <el-form-item label="è”ç³»ç”µè¯" required>
                                    <el-input v-model="receiverInfo.phone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯"></el-input>
                                </el-form-item>
                                <el-form-item label="æ”¶è´§åœ°å€" required>
                                    <el-input 
                                        v-model="receiverInfo.address" 
                                        type="textarea" 
                                        :rows="2"
                                        placeholder="è¯·è¾“å…¥è¯¦ç»†æ”¶è´§åœ°å€">
                                    </el-input>
                                </el-form-item>
                            </el-form>
                        </div>
                    </el-collapse-transition>
                </div>
                
                <!-- è‡ªæåœ°å€æç¤ºï¼ˆçº¿ä¸‹è‡ªææ—¶æ˜¾ç¤ºï¼‰ -->
                <div v-if="deliveryMethod === 2" style="margin-bottom: 20px;">
                    <el-alert 
                        title="è‡ªæåœ°å€" 
                        type="success" 
                        :closable="false">
                        <template #default>
                            <p style="margin: 0; font-size: 14px; line-height: 1.6;">
                                ğŸ“ <strong>æ‹å–è¡Œåœ°å€ï¼š</strong>åŒ—äº¬å¸‚æœé˜³åŒºå»ºå›½è·¯XXå·XXå¤§å¦10å±‚<br>
                                â° <strong>è‡ªææ—¶é—´ï¼š</strong>å·¥ä½œæ—¥ 9:00-18:00<br>
                                ğŸ“ <strong>è”ç³»ç”µè¯ï¼š</strong>010-12345678<br><br>
                                è¯·åœ¨æ”¯ä»˜æˆåŠŸå3ä¸ªå·¥ä½œæ—¥å†…å‰å¾€è‡ªæï¼Œé€¾æœŸæœªå–è§†ä¸ºæ”¾å¼ƒã€‚
                            </p>
                        </template>
                    </el-alert>
                </div>
                
                <!-- æ”¯ä»˜æ˜ç»† -->
                <div class="payment-detail-box">
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">æ‹å“æˆäº¤ä»·</span>
                        <span class="payment-detail-value">Â¥{{ Number(currentOrder.totalAmount || 0).toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">ä½£é‡‘ ({{ (sessionCommissionRate * 100).toFixed(1) }}%)</span>
                        <span class="payment-detail-value warning">+Â¥{{ commissionFee.toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">ä¿è¯é‡‘æŠµæ‰£</span>
                        <span class="payment-detail-value success">-Â¥{{ Number(currentOrder.depositAmount || 0).toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">å•†å“å°¾æ¬¾</span>
                        <span class="payment-detail-value">Â¥{{ Number(currentOrder.balanceAmount || 0).toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item" v-if="deliveryMethod === 1 && actualShippingFee > 0">
                        <span class="payment-detail-label">ç‰©æµè´¹ç”¨</span>
                        <span class="payment-detail-value warning">+Â¥{{ actualShippingFee.toFixed(2) }}</span>
                    </div>
                    <div class="payment-detail-item" v-if="deliveryMethod === 2 || sessionIsFreeShipping === 1">
                        <span class="payment-detail-label">é…é€æ–¹å¼</span>
                        <span class="payment-detail-value success">
                            {{ deliveryMethod === 2 ? 'çº¿ä¸‹è‡ªæï¼ˆå…è¿è´¹ï¼‰' : 'åŒ…é‚®ï¼ˆå…è¿è´¹ï¼‰' }}
                        </span>
                    </div>
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">å®ä»˜é‡‘é¢</span>
                        <span class="payment-detail-value highlight">Â¥{{ actualPayAmount.toFixed(2) }}</span>
                    </div>
                </div>
                
                <!-- ä¿è¯é‡‘ä½™é¢ä¿¡æ¯ -->
                <div class="payment-detail-box">
                    <div class="payment-detail-item">
                        <span class="payment-detail-label">æ‚¨çš„å¯ç”¨ä¿è¯é‡‘</span>
                        <span class="payment-detail-value" :class="hasEnoughBalance ? 'success' : 'warning'">
                            Â¥{{ Number(availableBalance || 0).toFixed(2) }}
                        </span>
                    </div>
                    <div class="payment-detail-item" v-if="!hasEnoughBalance">
                        <span class="payment-detail-label">è¿˜éœ€å……å€¼</span>
                        <span class="payment-detail-value warning">Â¥{{ Number(needRecharge || 0).toFixed(2) }}</span>
                    </div>
                </div>
                
                <!-- ä½™é¢ä¸è¶³è­¦å‘Š -->
                <div class="balance-warning-box" v-if="!hasEnoughBalance">
                    <h4>
                        <i class="el-icon-warning" style="color: #E6A23C;"></i>
                        ä¿è¯é‡‘ä½™é¢ä¸è¶³
                    </h4>
                    <p>
                        æ‚¨çš„å¯ç”¨ä¿è¯é‡‘ä¸º <strong>Â¥{{ Number(availableBalance || 0).toFixed(2) }}</strong>ï¼Œ<br>
                        æ”¯ä»˜é‡‘é¢éœ€è¦ <strong>Â¥{{ actualPayAmount.toFixed(2) }}</strong>
                        <span v-if="actualShippingFee > 0">ï¼ˆå°¾æ¬¾ + ç‰©æµè´¹ï¼‰</span>ï¼Œ<br>
                        è¿˜éœ€å……å€¼ <strong>Â¥{{ Number(needRecharge || 0).toFixed(2) }}</strong> æ‰èƒ½å®Œæˆæ”¯ä»˜ã€‚
                    </p>
                    <div style="margin-top: 15px;">
                        <el-button type="warning" @click="goToRecharge" style="width: 100%;">
                            ç«‹å³å……å€¼ Â¥{{ Number(needRecharge || 0).toFixed(2) }}
                        </el-button>
                    </div>
                </div>
                
                <!-- æ”¯ä»˜è¯´æ˜ -->
                <el-alert 
                    title="æ”¯ä»˜æ–¹å¼ï¼šä¿è¯é‡‘è´¦æˆ·" 
                    type="info" 
                    :closable="false"
                    style="margin-bottom: 20px;">
                    <template #default>
                        <p style="margin: 0; font-size: 13px; line-height: 1.6;">
                            â€¢ ä¿è¯é‡‘å°†è‡ªåŠ¨æŠµæ‰£è®¢å•é‡‘é¢<br>
                            â€¢ å°¾æ¬¾ä»æ‚¨çš„å¯ç”¨ä¿è¯é‡‘ä½™é¢ä¸­æ‰£é™¤<br>
                            â€¢ æ”¯ä»˜æˆåŠŸåè®¢å•ç«‹å³ç”Ÿæ•ˆ
                        </p>
                    </template>
                </el-alert>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div style="text-align: center; margin-top: 20px;">
                    <el-button @click="paymentDialogVisible = false" size="large">å–æ¶ˆ</el-button>
                    <el-button 
                        type="primary" 
                        @click="processPayment"
                        :disabled="!hasEnoughBalance"
                        :loading="paying"
                        size="large">
                        {{ hasEnoughBalance ? 'ç¡®è®¤æ”¯ä»˜' : 'ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼' }}
                    </el-button>
                </div>
            </div>
        </el-dialog>

        <!-- è®¢å•è¯¦æƒ…å¯¹è¯æ¡† -->
        <el-dialog
            v-model="orderDetailVisible"
            title="è®¢å•è¯¦æƒ…"
            width="800px"
            :close-on-click-modal="false">
            <div v-if="currentOrderDetail" class="order-detail-content">
                <!-- è®¢å•åŸºæœ¬ä¿¡æ¯ -->
                <div class="detail-section">
                    <h4>è®¢å•ä¿¡æ¯</h4>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span class="detail-label">è®¢å•å·ï¼š</span>
                            <span class="detail-value">{{ currentOrderDetail.orderNo }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">è®¢å•çŠ¶æ€ï¼š</span>
                            <el-tag :type="getOrderStatusTag(currentOrderDetail.status)">
                                {{ getOrderStatusText(currentOrderDetail.status) }}
                            </el-tag>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">åˆ›å»ºæ—¶é—´ï¼š</span>
                            <span class="detail-value">{{ formatDateTime(currentOrderDetail.createTime) }}</span>
                        </div>
                        <div class="detail-item" v-if="currentOrderDetail.paymentTime">
                            <span class="detail-label">æ”¯ä»˜æ—¶é—´ï¼š</span>
                            <span class="detail-value">{{ formatDateTime(currentOrderDetail.paymentTime) }}</span>
                        </div>
                        <div class="detail-item" v-if="currentOrderDetail.shipTime">
                            <span class="detail-label">å‘è´§æ—¶é—´ï¼š</span>
                            <span class="detail-value">{{ formatDateTime(currentOrderDetail.shipTime) }}</span>
                        </div>
                        <div class="detail-item" v-if="currentOrderDetail.receiveTime">
                            <span class="detail-label">æ”¶è´§æ—¶é—´ï¼š</span>
                            <span class="detail-value">{{ formatDateTime(currentOrderDetail.receiveTime) }}</span>
                        </div>
                    </div>
                </div>

                <!-- æ‹å“ä¿¡æ¯ -->
                <div class="detail-section" v-if="currentOrderDetail.item">
                    <h4>æ‹å“ä¿¡æ¯</h4>
                    <div class="item-info">
                        <div class="item-image" v-if="currentOrderDetail.item.imageUrl">
                            <img :src="currentOrderDetail.item.imageUrl" :alt="currentOrderDetail.item.name">
                        </div>
                        <div class="item-details">
                            <h5>{{ currentOrderDetail.item.name }}</h5>
                            <p class="item-description">{{ currentOrderDetail.item.description }}</p>
                            <div class="item-meta">
                                <span class="meta-item">èµ·æ‹ä»·ï¼šÂ¥{{ Number(currentOrderDetail.item.startPrice || 0).toFixed(2) }}</span>
                                <span class="meta-item">æˆäº¤ä»·ï¼šÂ¥{{ Number(currentOrderDetail.totalAmount || 0).toFixed(2) }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è´¹ç”¨æ˜ç»† -->
                <div class="detail-section">
                    <h4>è´¹ç”¨æ˜ç»†</h4>
                    <div class="cost-breakdown">
                        <div class="cost-item">
                            <span class="cost-label">æ‹å“æˆäº¤ä»·ï¼š</span>
                            <span class="cost-value">Â¥{{ Number(currentOrderDetail.totalAmount || 0).toFixed(2) }}</span>
                        </div>
                        <div class="cost-item" v-if="currentOrderDetail.depositAmount">
                            <span class="cost-label">ä¿è¯é‡‘æŠµæ‰£ï¼š</span>
                            <span class="cost-value success">-Â¥{{ Number(currentOrderDetail.depositAmount || 0).toFixed(2) }}</span>
                        </div>
                        <div class="cost-item" v-if="currentOrderDetail.balanceAmount">
                            <span class="cost-label">å•†å“å°¾æ¬¾ï¼š</span>
                            <span class="cost-value">Â¥{{ Number(currentOrderDetail.balanceAmount || 0).toFixed(2) }}</span>
                        </div>
                        <div class="cost-item" v-if="currentOrderDetail.shippingFee && currentOrderDetail.shippingFee > 0">
                            <span class="cost-label">ç‰©æµè´¹ç”¨ï¼š</span>
                            <span class="cost-value warning">+Â¥{{ Number(currentOrderDetail.shippingFee || 0).toFixed(2) }}</span>
                        </div>
                        <div class="cost-item total">
                            <span class="cost-label">å®ä»˜é‡‘é¢ï¼š</span>
                            <span class="cost-value highlight">Â¥{{ getTotalPaidAmount(currentOrderDetail).toFixed(2) }}</span>
                        </div>
                    </div>
                </div>

                <!-- æ”¶è´§ä¿¡æ¯ -->
                <div class="detail-section" v-if="currentOrderDetail.deliveryMethod">
                    <h4>æ”¶è´§ä¿¡æ¯</h4>
                    <div class="delivery-info">
                        <div class="delivery-method">
                            <span class="detail-label">é…é€æ–¹å¼ï¼š</span>
                            <span class="detail-value">
                                {{ currentOrderDetail.deliveryMethod === 1 ? 'ç‰©æµé…é€' : 'çº¿ä¸‹è‡ªæ' }}
                            </span>
                        </div>
                        <div v-if="currentOrderDetail.deliveryMethod === 1">
                            <div class="detail-item">
                                <span class="detail-label">æ”¶è´§äººï¼š</span>
                                <span class="detail-value">{{ currentOrderDetail.receiverName }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">è”ç³»ç”µè¯ï¼š</span>
                                <span class="detail-value">{{ currentOrderDetail.receiverPhone }}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">æ”¶è´§åœ°å€ï¼š</span>
                                <span class="detail-value">{{ currentOrderDetail.receiverAddress }}</span>
                            </div>
                        </div>
                        <div v-else>
                            <div class="detail-item">
                                <span class="detail-label">è‡ªæåœ°å€ï¼š</span>
                                <span class="detail-value">{{ currentOrderDetail.pickupAddress }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <template #footer>
                <el-button @click="orderDetailVisible = false">å…³é—­</el-button>
            </template>
        </el-dialog>
    </div>

    <!-- Element UI JS - ä½¿ç”¨CDN -->
    <script src="/js/vue.js"></script>
    <script src="/js/element-plus.js"></script>
    <script src="/js/axios.js"></script>
    
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    loading: false,
                    isLoggedIn: false,
                    userInfo: {},
                    unreadNotifications: 0,
                    searchKeyword: '',
                    statusFilter: '',
                    dateRange: null,
                    orders: [],
                    currentPage: 1,
                    pageSize: 10,
                    totalCount: 0,
                    paymentDialogVisible: false,
                    currentOrder: null,
                    orderDetailVisible: false,
                    currentOrderDetail: null,
                    selectedPaymentMethod: '',
                    paying: false,
                    // ä¿è¯é‡‘è´¦æˆ·ä¿¡æ¯
                    availableBalance: 0,
                    frozenBalance: 0,
                    // é…é€ä¿¡æ¯
                    deliveryMethod: 1, // 1-ç‰©æµé…é€ï¼Œ2-çº¿ä¸‹è‡ªæ
                    shippingFee: 15, // é»˜è®¤ç‰©æµè´¹ç”¨15å…ƒ
                    receiverInfo: {
                        name: '',
                        phone: '',
                        address: ''
                    },
                    // åœ°å€ç®¡ç†
                    savedAddresses: [], // ä¿å­˜çš„åœ°å€åˆ—è¡¨
                    selectedAddressId: 0, // é€‰ä¸­çš„åœ°å€IDï¼Œ0è¡¨ç¤ºæ‰‹åŠ¨è¾“å…¥
                    // ç‰©æµå…¬å¸ç®¡ç†
                    logisticsCompanies: [], // ç‰©æµå…¬å¸åˆ—è¡¨
                    selectedLogisticsCompanyId: null, // é€‰ä¸­çš„ç‰©æµå…¬å¸ID
                    // æ‹å–ä¼šä¿¡æ¯
                    sessionCommissionRate: 0, // æ‹å–ä¼šä½£é‡‘æ¯”ä¾‹
                    sessionIsFreeShipping: 0, // æ‹å–ä¼šæ˜¯å¦åŒ…é‚®
                    commissionFee: 0 // ä½£é‡‘è´¹ç”¨
                }
            },
            computed: {
                filteredOrders() {
                    let filtered = this.orders;
                    
                    if (this.searchKeyword) {
                        filtered = filtered.filter(order => 
                            order.orderNumber.toLowerCase().includes(this.searchKeyword.toLowerCase()) ||
                            order.itemName.toLowerCase().includes(this.searchKeyword.toLowerCase())
                        );
                    }
                    
                    if (this.statusFilter) {
                        filtered = filtered.filter(order => order.status === this.statusFilter);
                    }
                    
                    if (this.dateRange && this.dateRange.length === 2) {
                        const startDate = new Date(this.dateRange[0]);
                        const endDate = new Date(this.dateRange[1]);
                        filtered = filtered.filter(order => {
                            const orderDate = new Date(order.createTime);
                            return orderDate >= startDate && orderDate <= endDate;
                        });
                    }
                    
                    return filtered;
                },
                totalPages() {
                    return Math.ceil(this.totalCount / this.pageSize);
                },
                // è®¡ç®—å®é™…ç‰©æµè´¹ï¼ˆå¦‚æœåŒ…é‚®åˆ™ä¸º0ï¼‰
                actualShippingFee() {
                    if (!this.currentOrder) return 0;
                    // å¦‚æœæ˜¯çº¿ä¸‹è‡ªæï¼Œç‰©æµè´¹ä¸º0
                    if (this.deliveryMethod === 2) return 0;
                    
                    // æ£€æŸ¥æ‹å–ä¼šæ˜¯å¦åŒ…é‚®ï¼ˆä»æ‹å–ä¼šè¡¨çš„isFreeShippingå­—æ®µè¯»å–ï¼‰
                    if (this.sessionIsFreeShipping === 1) return 0;
                    
                    // å¦‚æœé€‰æ‹©äº†ç‰©æµå…¬å¸ï¼Œä½¿ç”¨ç‰©æµå…¬å¸è®¡ç®—çš„è´¹ç”¨
                    if (this.selectedLogisticsCompanyId && this.deliveryMethod === 1) {
                        const company = this.logisticsCompanies.find(c => c.id === this.selectedLogisticsCompanyId);
                        if (company) {
                            return this.calculateCompanyFee(company);
                        }
                    }
                    
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©ç‰©æµå…¬å¸ï¼Œè¿”å›0ï¼ˆç­‰å¾…ç”¨æˆ·é€‰æ‹©ï¼‰
                    return 0;
                },
                // è®¡ç®—å®é™…éœ€è¦æ”¯ä»˜çš„é‡‘é¢ï¼ˆå°¾æ¬¾ + ç‰©æµè´¹ï¼‰
                actualPayAmount() {
                    if (!this.currentOrder) return 0;
                    const balance = Number(this.currentOrder.balanceAmount || 0);
                    return balance + this.actualShippingFee;
                },
                // æ£€æŸ¥ä¿è¯é‡‘ä½™é¢æ˜¯å¦è¶³å¤Ÿï¼ˆåŒ…å«ç‰©æµè´¹ï¼‰
                hasEnoughBalance() {
                    return this.availableBalance >= this.actualPayAmount;
                },
                // è®¡ç®—è¿˜éœ€å……å€¼çš„é‡‘é¢ï¼ˆåŒ…å«ç‰©æµè´¹ï¼‰
                needRecharge() {
                    const shortage = this.actualPayAmount - this.availableBalance;
                    return Math.max(0, shortage);
                }
            },
            mounted() {
                this.setupAxiosInterceptors();
                this.checkLoginStatus();
                if (this.isLoggedIn) {
                    this.loadOrders();
                    this.loadDepositBalance();
                    this.loadUnreadNotifications();
                    // æ¯30ç§’åˆ·æ–°æœªè¯»é€šçŸ¥æ•°
                    setInterval(() => {
                        if (this.isLoggedIn) {
                            this.loadUnreadNotifications();
                        }
                    }, 30000);
                }
            },
            methods: {
                // è®¾ç½®axiosæ‹¦æˆªå™¨
                setupAxiosInterceptors() {
                    // è¯·æ±‚æ‹¦æˆªå™¨ - è‡ªåŠ¨æ·»åŠ Authorizationå¤´
                    axios.interceptors.request.use(
                        config => {
                            const token = localStorage.getItem('accessToken');
                            if (token) {
                                config.headers.Authorization = `Bearer ${token}`;
                            }
                            return config;
                        },
                        error => {
                            return Promise.reject(error);
                        }
                    );
                    
                    // å“åº”æ‹¦æˆªå™¨ - å¤„ç†401é”™è¯¯
                    axios.interceptors.response.use(
                        response => response,
                        async error => {
                            if (error.response && error.response.status === 401) {
                                // å°è¯•åˆ·æ–°Token
                                const refreshToken = localStorage.getItem('refreshToken');
                                if (refreshToken) {
                                    try {
                                        const response = await axios.post('/api/auth/refresh', {
                                            refreshToken: refreshToken
                                        });
                                        
                                        if (response.data.code === 200) {
                                            const newAccessToken = response.data.data.accessToken;
                                            localStorage.setItem('accessToken', newAccessToken);
                                            error.config.headers.Authorization = `Bearer ${newAccessToken}`;
                                            return axios.request(error.config);
                                        }
                                    } catch (refreshError) {
                                        console.error('Tokenåˆ·æ–°å¤±è´¥:', refreshError);
                                    }
                                }
                                
                                // åˆ·æ–°å¤±è´¥ï¼Œæ¸…é™¤tokenå¹¶è·³è½¬
                                localStorage.removeItem('accessToken');
                                localStorage.removeItem('refreshToken');
                                localStorage.removeItem('userInfo');
                                this.isLoggedIn = false;
                                this.userInfo = {};
                                ElMessage.error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                                window.location.href = '/auction/login';
                            }
                            return Promise.reject(error);
                        }
                    );
                },
                
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                checkLoginStatus() {
                    const accessToken = localStorage.getItem('accessToken');
                    const refreshToken = localStorage.getItem('refreshToken');
                    const userInfoStr = localStorage.getItem('userInfo');
                    
                    if (accessToken && refreshToken) {
                        this.isLoggedIn = true;
                        if (userInfoStr) {
                            this.userInfo = JSON.parse(userInfoStr);
                        } else {
                            this.userInfo = {
                                username: 'buyer1',
                                nickname: 'ä¹°å®¶1'
                            };
                        }
                    } else {
                        // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                        this.isLoggedIn = false;
                        ElMessage.warning('è¯·å…ˆç™»å½•');
                        window.location.href = '/auction/login';
                    }
                },
                
                // åŠ è½½è®¢å•åˆ—è¡¨
                loadOrders() {
                    this.loading = true;
                    axios.get('/api/user/orders', {
                        params: {
                            page: this.currentPage,
                            size: this.pageSize
                        }
                    })
                    .then(response => {
                        console.log('è®¢å•æ¥å£è¿”å›:', response.data);
                        if (response.data.code === 200) {
                            // åç«¯è¿”å›çš„æ•°æ®ç»“æ„æ˜¯ data.data.data
                            const result = response.data.data;
                            this.orders = result.data || [];
                            this.totalCount = result.total || 0;
                            console.log('è®¢å•åˆ—è¡¨:', this.orders);
                            console.log('è®¢å•æ€»æ•°:', this.totalCount);
                        } else {
                            ElMessage.error(response.data.message || 'åŠ è½½è®¢å•åˆ—è¡¨å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        console.error('åŠ è½½è®¢å•åˆ—è¡¨é”™è¯¯:', error);
                        ElMessage.error('åŠ è½½è®¢å•åˆ—è¡¨å¤±è´¥');
                    })
                    .finally(() => {
                        this.loading = false;
                    });
                },
                
                // æœç´¢
                handleSearch() {
                    // æœç´¢é€»è¾‘åœ¨ computed ä¸­å¤„ç†
                },
                
                // ç­›é€‰
                handleFilter() {
                    // ç­›é€‰é€»è¾‘åœ¨ computed ä¸­å¤„ç†
                },
                
                // é‡ç½®ç­›é€‰
                resetFilter() {
                    this.searchKeyword = '';
                    this.statusFilter = '';
                    this.dateRange = null;
                },
                
                // åˆ†é¡µ
                handlePageChange(page) {
                    this.currentPage = page;
                    this.loadOrders();
                },
                
                // è·å–çŠ¶æ€æ ·å¼ç±»
                getStatusClass(status) {
                    // æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²ä¸¤ç§æ ¼å¼
                    const statusMap = {
                        1: 'status-pending',
                        2: 'status-paid',
                        3: 'status-shipped',
                        4: 'status-delivered',
                        5: 'status-delivered',
                        6: 'status-cancelled',
                        'pending': 'status-pending',
                        'paid': 'status-paid',
                        'shipped': 'status-shipped',
                        'delivered': 'status-delivered',
                        'cancelled': 'status-cancelled'
                    };
                    return statusMap[status] || 'status-pending';
                },
                
                // è·å–çŠ¶æ€æ–‡æœ¬
                getStatusText(status) {
                    // æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²ä¸¤ç§æ ¼å¼
                    const statusMap = {
                        1: 'å¾…æ”¯ä»˜',
                        2: 'å·²æ”¯ä»˜',
                        3: 'å·²å‘è´§',
                        4: 'å·²æ”¶è´§',
                        5: 'å·²å®Œæˆ',
                        6: 'å·²å–æ¶ˆ',
                        'pending': 'å¾…æ”¯ä»˜',
                        'paid': 'å·²æ”¯ä»˜',
                        'shipped': 'å·²å‘è´§',
                        'delivered': 'å·²æ”¶è´§',
                        'cancelled': 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || status;
                },
                
                // æ ¼å¼åŒ–æ—¶é—´
                formatTime(time) {
                    return new Date(time).toLocaleString('zh-CN');
                },
                
                // åŠ è½½ä¿è¯é‡‘ä½™é¢
                loadDepositBalance() {
                    axios.get('/api/deposit/account')
                        .then(response => {
                            if (response.data.code === 200) {
                                const data = response.data.data;
                                this.availableBalance = Number(data.availableAmount || 0);
                                this.frozenBalance = Number(data.frozenAmount || 0);
                            }
                        })
                        .catch(error => {
                            console.error('åŠ è½½ä¿è¯é‡‘ä½™é¢å¤±è´¥:', error);
                        });
                },
                
                // åŠ è½½åœ°å€åˆ—è¡¨
                loadAddresses() {
                    axios.get('/api/user/addresses/list')
                        .then(response => {
                            if (response.data.code === 200) {
                                this.savedAddresses = response.data.data || [];
                                // å¦‚æœæœ‰é»˜è®¤åœ°å€ï¼Œè‡ªåŠ¨é€‰ä¸­
                                const defaultAddr = this.savedAddresses.find(addr => addr.isDefault === 1);
                                if (defaultAddr) {
                                    this.selectedAddressId = defaultAddr.id;
                                    this.onAddressSelect(defaultAddr.id);
                                }
                            }
                        })
                        .catch(error => {
                            console.error('åŠ è½½åœ°å€åˆ—è¡¨å¤±è´¥:', error);
                        });
                },
                
                // åŠ è½½ç‰©æµå…¬å¸åˆ—è¡¨
                loadLogisticsCompanies() {
                    axios.get('/api/user/logistics-companies')
                        .then(response => {
                            if (response.data.code === 200) {
                                this.logisticsCompanies = response.data.data || [];
                                // å¦‚æœæœ‰ç‰©æµå…¬å¸ï¼Œé»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                                if (this.logisticsCompanies.length > 0) {
                                    this.selectedLogisticsCompanyId = this.logisticsCompanies[0].id;
                                }
                            }
                        })
                        .catch(error => {
                            console.error('åŠ è½½ç‰©æµå…¬å¸åˆ—è¡¨å¤±è´¥:', error);
                        });
                },
                
                // è®¡ç®—ç‰©æµå…¬å¸è´¹ç”¨
                calculateCompanyFee(company) {
                    if (!company || !this.currentOrder) return 0;
                    
                    const orderAmount = Number(this.currentOrder.totalAmount || 0);
                    const baseFee = Number(company.baseFee || 0);
                    const insuranceRate = Number(company.insuranceRate || 0);
                    
                    // ä¿ä»·è´¹ç”¨ = è®¢å•é‡‘é¢ * ä¿ä»·è´¹ç‡ / 100
                    const insuranceFee = orderAmount * insuranceRate / 100;
                    
                    // æ€»è´¹ç”¨ = åŸºç¡€è¿è´¹ + ä¿ä»·è´¹ç”¨
                    return baseFee + insuranceFee;
                },
                
                // é…é€æ–¹å¼æ”¹å˜
                onDeliveryMethodChange() {
                    // é‡ç½®ç‰©æµå…¬å¸é€‰æ‹©
                    this.selectedLogisticsCompanyId = null;
                    if (this.deliveryMethod === 1 && this.logisticsCompanies.length > 0) {
                        this.selectedLogisticsCompanyId = this.logisticsCompanies[0].id;
                    }
                },
                
                // ç‰©æµå…¬å¸æ”¹å˜
                onLogisticsCompanyChange() {
                    // ç‰©æµå…¬å¸æ”¹å˜æ—¶ï¼Œè´¹ç”¨ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—
                    console.log('ç‰©æµå…¬å¸æ”¹å˜:', this.selectedLogisticsCompanyId);
                },
                
                // é€‰æ‹©åœ°å€
                onAddressSelect(addressId) {
                    if (addressId === 0) {
                        // æ‰‹åŠ¨è¾“å…¥ï¼Œæ¸…ç©ºæ”¶è´§ä¿¡æ¯
                        this.receiverInfo = { name: '', phone: '', address: '' };
                        return;
                    }
                    
                    const addr = this.savedAddresses.find(a => a.id === addressId);
                    if (addr) {
                        this.receiverInfo.name = addr.receiverName;
                        this.receiverInfo.phone = addr.receiverPhone;
                        this.receiverInfo.address = addr.fullAddress;
                    }
                },
                
                // è·³è½¬åˆ°åœ°å€ç®¡ç†é¡µé¢
                goToAddressManage() {
                    window.location.href = '/auction/user/addresses';
                },
                
                // æ˜¾ç¤ºæ”¯ä»˜å¯¹è¯æ¡†
                async showPaymentDialog(order) {
                    this.currentOrder = order;
                    this.selectedPaymentMethod = '';
                    // é‡ç½®é…é€ä¿¡æ¯
                    this.deliveryMethod = 1;
                    this.receiverInfo = { name: '', phone: '', address: '' };
                    this.selectedAddressId = 0;
                    this.selectedLogisticsCompanyId = null;
                    
                    // åŠ è½½æ‹å–ä¼šä¿¡æ¯ä»¥è·å–ä½£é‡‘æ¯”ä¾‹å’ŒåŒ…é‚®ä¿¡æ¯
                    try {
                        const sessionResponse = await axios.get(`/api/user/sessions/${order.sessionId}`);
                        if (sessionResponse.data.code === 200) {
                            const sessionData = sessionResponse.data.data;
                            this.sessionCommissionRate = Number(sessionData.commissionRatio || 0);
                            this.sessionIsFreeShipping = sessionData.isFreeShipping || 0;
                            
                            // è®¡ç®—ä½£é‡‘è´¹ç”¨ = æˆäº¤ä»· Ã— ä½£é‡‘æ¯”ä¾‹ï¼ˆcommissionRatioå·²ç»æ˜¯å°æ•°ï¼Œå¦‚0.05ä»£è¡¨5%ï¼‰
                            this.commissionFee = Number(order.totalAmount || 0) * this.sessionCommissionRate;
                        }
                    } catch (e) {
                        console.error('åŠ è½½æ‹å–ä¼šä¿¡æ¯å¤±è´¥:', e);
                        // ä½¿ç”¨é»˜è®¤å€¼
                        this.sessionCommissionRate = 0;
                        this.sessionIsFreeShipping = 0;
                        this.commissionFee = 0;
                    }
                    
                    // åˆ·æ–°ä¿è¯é‡‘ä½™é¢
                    this.loadDepositBalance();
                    // åŠ è½½åœ°å€åˆ—è¡¨
                    this.loadAddresses();
                    // åŠ è½½ç‰©æµå…¬å¸åˆ—è¡¨
                    this.loadLogisticsCompanies();
                    this.paymentDialogVisible = true;
                },
                
                // å¤„ç†æ”¯ä»˜
                processPayment() {
                    // æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
                    if (!this.hasEnoughBalance) {
                        ElMessage.warning('ä¿è¯é‡‘ä½™é¢ä¸è¶³ï¼Œè¯·å…ˆå……å€¼');
                        return;
                    }
                    
                    // å¦‚æœé€‰æ‹©ç‰©æµé…é€ï¼ŒéªŒè¯æ”¶è´§ä¿¡æ¯å’Œç‰©æµå…¬å¸
                    if (this.deliveryMethod === 1) {
                        if (!this.receiverInfo.name || !this.receiverInfo.phone || !this.receiverInfo.address) {
                            ElMessage.error('è¯·å¡«å†™å®Œæ•´çš„æ”¶è´§ä¿¡æ¯');
                            return;
                        }
                        // éªŒè¯æ‰‹æœºå·æ ¼å¼
                        const phoneReg = /^1[3-9]\d{9}$/;
                        if (!phoneReg.test(this.receiverInfo.phone)) {
                            ElMessage.error('è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·');
                            return;
                        }
                        // éªŒè¯æ˜¯å¦é€‰æ‹©äº†ç‰©æµå…¬å¸ï¼ˆéåŒ…é‚®æƒ…å†µä¸‹ï¼‰
                        const isFreeShipping = this.currentOrder.item?.isFreeShipping || this.currentOrder.isFreeShipping;
                        if (!isFreeShipping && !this.selectedLogisticsCompanyId) {
                            ElMessage.error('è¯·é€‰æ‹©ç‰©æµå…¬å¸');
                            return;
                        }
                    }
                    
                    // æ„å»ºç¡®è®¤ä¿¡æ¯
                    let confirmMsg = `ç¡®è®¤æ”¯ä»˜è®¢å•ï¼Ÿ<br><br>` +
                        `è®¢å•æ€»é¢ï¼šÂ¥${Number(this.currentOrder.totalAmount || 0).toFixed(2)}<br>` +
                        `ä¿è¯é‡‘æŠµæ‰£ï¼š-Â¥${Number(this.currentOrder.depositAmount || 0).toFixed(2)}<br>` +
                        `å•†å“å°¾æ¬¾ï¼šÂ¥${Number(this.currentOrder.balanceAmount || 0).toFixed(2)}<br>`;
                    
                    if (this.actualShippingFee > 0) {
                        confirmMsg += `ç‰©æµè´¹ç”¨ï¼š+Â¥${this.actualShippingFee.toFixed(2)}<br>`;
                    }
                    
                    confirmMsg += `<strong style="color: #F56C6C;">å®ä»˜é‡‘é¢ï¼šÂ¥${this.actualPayAmount.toFixed(2)}</strong><br><br>`;
                    
                    if (this.deliveryMethod === 1) {
                        confirmMsg += `ğŸ“¦ é…é€æ–¹å¼ï¼šç‰©æµé…é€<br>`;
                        confirmMsg += `ğŸ“ æ”¶è´§åœ°å€ï¼š${this.receiverInfo.address}<br>`;
                    } else {
                        confirmMsg += `ğŸ“¦ é…é€æ–¹å¼ï¼šçº¿ä¸‹è‡ªæ<br>`;
                    }
                    
                    confirmMsg += `<br><strong style="color: #E6A23C;">æ”¯ä»˜åå°†ä»æ‚¨çš„ä¿è¯é‡‘è´¦æˆ·æ‰£æ¬¾</strong>`;
                    
                    // äºŒæ¬¡ç¡®è®¤
                    ElMessageBox.confirm(confirmMsg, 'ç¡®è®¤æ”¯ä»˜', {
                        confirmButtonText: 'ç¡®è®¤æ”¯ä»˜',
                        cancelButtonText: 'å–æ¶ˆ',
                        type: 'warning',
                        dangerouslyUseHTMLString: true
                    }).then(() => {
                        this.paying = true;
                        const paymentData = {
                            orderId: this.currentOrder.id,
                            paymentMethod: 'deposit',
                            deliveryMethod: this.deliveryMethod,
                            shippingFee: this.actualShippingFee,
                            logisticsCompanyId: this.selectedLogisticsCompanyId,
                            receiverName: this.receiverInfo.name,
                            receiverPhone: this.receiverInfo.phone,
                            receiverAddress: this.receiverInfo.address
                        };
                        
                        axios.post('/api/user/orders/pay', paymentData)
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success('æ”¯ä»˜æˆåŠŸ');
                                    this.paymentDialogVisible = false;
                                    this.loadOrders();
                                    this.loadDepositBalance();
                                } else {
                                    ElMessage.error(response.data.message || 'æ”¯ä»˜å¤±è´¥');
                                }
                            })
                            .catch(error => {
                                console.error('æ”¯ä»˜é”™è¯¯:', error);
                                ElMessage.error(error.response?.data?.message || 'æ”¯ä»˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                            })
                            .finally(() => {
                                this.paying = false;
                            });
                    }).catch(() => {
                        // ç”¨æˆ·å–æ¶ˆ
                    });
                },
                
                // è·³è½¬åˆ°å……å€¼é¡µé¢
                goToRecharge() {
                    this.paymentDialogVisible = false;
                    window.location.href = '/auction/user/deposits';
                },
                
                // å–æ¶ˆè®¢å•
                cancelOrder(order) {
                    ElMessageBox.confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿ', 'æç¤º', {
                        confirmButtonText: 'ç¡®å®š',
                        cancelButtonText: 'å–æ¶ˆ',
                        type: 'warning'
                    }).then(() => {
                        axios.post(`/api/user/orders/${order.id}/cancel`)
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success('è®¢å•å·²å–æ¶ˆ');
                                    this.loadOrders();
                                } else {
                                    ElMessage.error(response.data.message || 'å–æ¶ˆå¤±è´¥');
                                }
                            })
                            .catch(error => {
                                console.error('å–æ¶ˆè®¢å•é”™è¯¯:', error);
                                ElMessage.error('å–æ¶ˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                            });
                    });
                },
                
                // ç¡®è®¤æ”¶è´§
                confirmReceive(order) {
                    ElMessageBox.confirm('ç¡®å®šå·²æ”¶åˆ°å•†å“å—ï¼Ÿ', 'æç¤º', {
                        confirmButtonText: 'ç¡®å®š',
                        cancelButtonText: 'å–æ¶ˆ',
                        type: 'warning'
                    }).then(() => {
                        axios.post(`/api/user/orders/${order.id}/confirm`)
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success('ç¡®è®¤æ”¶è´§æˆåŠŸ');
                                    this.loadOrders();
                                } else {
                                    ElMessage.error(response.data.message || 'ç¡®è®¤æ”¶è´§å¤±è´¥');
                                }
                            })
                            .catch(error => {
                                console.error('ç¡®è®¤æ”¶è´§é”™è¯¯:', error);
                                ElMessage.error('ç¡®è®¤æ”¶è´§å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                            });
                    });
                },
                
                
                // è·³è½¬åˆ°ç™»å½•é¡µé¢
                async loadUnreadNotifications() {
                    try {
                        const response = await axios.get('/api/notifications/unread-count');
                        if (response.data.code === 200) {
                            this.unreadNotifications = response.data.data;
                        }
                    } catch (error) {
                        console.error('è·å–æœªè¯»é€šçŸ¥æ•°å¤±è´¥:', error);
                    }
                },
                
                goToNotifications() {
                    window.location.href = '/auction/user/notifications';
                },
                
                goToLogin() {
                    window.location.href = '/auction/login';
                },
                
                // æ˜¾ç¤ºè®¢å•è¯¦æƒ…
                showOrderDetail(order) {
                    this.currentOrderDetail = order;
                    this.orderDetailVisible = true;
                },
                
                // è®¡ç®—å®ä»˜é‡‘é¢
                getTotalPaidAmount(order) {
                    if (!order) return 0;
                    const balanceAmount = Number(order.balanceAmount || 0);
                    const shippingFee = Number(order.shippingFee || 0);
                    return balanceAmount + shippingFee;
                },
                
                // è·å–è®¢å•çŠ¶æ€æ ‡ç­¾ç±»å‹
                getOrderStatusTag(status) {
                    const statusMap = {
                        1: 'warning',  // å¾…æ”¯ä»˜
                        2: 'success',  // å·²æ”¯ä»˜
                        3: 'info',     // å·²å‘è´§
                        4: 'success',  // å·²æ”¶è´§
                        5: 'success',  // å·²å®Œæˆ
                        6: 'danger'    // å·²å–æ¶ˆ
                    };
                    return statusMap[status] || 'info';
                },
                
                // è·å–è®¢å•çŠ¶æ€æ–‡æœ¬
                getOrderStatusText(status) {
                    const statusMap = {
                        1: 'å¾…æ”¯ä»˜',
                        2: 'å·²æ”¯ä»˜',
                        3: 'å·²å‘è´§',
                        4: 'å·²æ”¶è´§',
                        5: 'å·²å®Œæˆ',
                        6: 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || 'æœªçŸ¥';
                },
                
                // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
                formatDateTime(dateTime) {
                    if (!dateTime) return '-';
                    const date = new Date(dateTime);
                    if (isNaN(date.getTime())) return '-';
                    
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    
                    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
                },
                
                // é€€å‡ºç™»å½•
                logout() {
                    ElMessageBox.confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ', 'æç¤º', {
                        confirmButtonText: 'ç¡®å®š',
                        cancelButtonText: 'å–æ¶ˆ',
                        type: 'warning'
                    }).then(() => {
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userInfo');
                        axios.post('/api/auth/logout').finally(() => {
                            this.isLoggedIn = false;
                            this.userInfo = {};
                            ElMessage.success('å·²é€€å‡ºç™»å½•');
                            window.location.reload();
                        });
                    });
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
    
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地址管理 - 拍卖系统</title>
    
    <!-- Element UI CSS - 使用CDN -->
    <link rel="stylesheet" href="/css/element-plus.css">
    <!-- 自定义样式 -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
            text-decoration: none;
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 28px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #303133;
            margin: 0;
        }
        
        .page-description {
            color: #606266;
            margin: 10px 0 0 0;
        }
        
        .address-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .address-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .address-card:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        
        .address-card.default {
            border: 2px solid #409EFF;
        }
        
        .default-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: #409EFF;
            color: white;
            padding: 4px 12px;
            border-radius: 0 8px 0 8px;
            font-size: 12px;
        }
        
        .address-info {
            margin-bottom: 15px;
        }
        
        .address-name {
            font-size: 16px;
            font-weight: bold;
            color: #303133;
            margin-bottom: 8px;
        }
        
        .address-phone {
            color: #606266;
            margin-bottom: 8px;
        }
        
        .address-detail {
            color: #909399;
            line-height: 1.6;
        }
        
        .address-tag {
            display: inline-block;
            padding: 2px 10px;
            background: #F4F4F5;
            color: #909399;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .address-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #EBEEF5;
        }
        
        .empty-state {
            background: white;
            border-radius: 8px;
            padding: 60px 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .empty-icon {
            font-size: 64px;
            color: #DCDFE6;
            margin-bottom: 20px;
        }
        
        .empty-text {
            color: #909399;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .add-address-card {
            background: white;
            border: 2px dashed #DCDFE6;
            border-radius: 8px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .add-address-card:hover {
            border-color: #409EFF;
            background: #F0F9FF;
        }
        
        .add-icon {
            font-size: 48px;
            color: #909399;
            margin-bottom: 15px;
        }
        
        .add-text {
            color: #606266;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 顶部导航 -->
        <el-header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="el-icon-gavel"></i>
                    <span>拍卖系统</span>
                </div>
                <div class="nav-links">
                    <el-link href="/auction/user/sessions" :underline="false">拍卖会</el-link>
                    <el-link href="/auction/user/orders" :underline="false">我的订单</el-link>
                    <el-link href="/auction/user/deposits" :underline="false">保证金</el-link>
                    <el-link :underline="false" disabled style="font-weight: bold; color: #409EFF; cursor: not-allowed;">收货地址</el-link>
                    <el-link href="/auction/user/notifications" :underline="false">我的通知</el-link>
                </div>
                <div class="user-info" v-if="isLoggedIn">
                    <el-badge :value="unreadCount" :hidden="unreadCount === 0" style="margin-right: 15px;">
                        <el-button icon="el-icon-bell" circle @click="goToNotifications"></el-button>
                    </el-badge>
                    <span>欢迎，{{ userInfo.nickname || userInfo.username }}</span>
                    <el-button @click="logout" type="danger" size="small">退出登录</el-button>
                </div>
                <div class="user-info" v-else>
                    <el-button @click="goToLogin" type="primary" size="small">登录</el-button>
                </div>
            </div>
        </el-header>

        <!-- 主内容区 -->
        <div class="main-content">
            <!-- 页面头部 -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">收货地址</h1>
                    <p class="page-description">管理您的收货地址，方便快捷下单</p>
                </div>
                <el-button type="primary" @click="showAddDialog" icon="Plus">
                    添加新地址
                </el-button>
            </div>

            <!-- 地址列表 -->
            <div v-if="addresses.length > 0" class="address-list">
                <div 
                    v-for="address in addresses" 
                    :key="address.id" 
                    class="address-card"
                    :class="{ 'default': address.isDefault === 1 }">
                    
                    <div v-if="address.isDefault === 1" class="default-badge">
                        默认地址
                    </div>
                    
                    <div class="address-info">
                        <div class="address-name">
                            {{ address.receiverName }}
                            <el-tag v-if="address.tag" size="small" style="margin-left: 8px;">
                                {{ address.tag }}
                            </el-tag>
                        </div>
                        <div class="address-phone">{{ address.receiverPhone }}</div>
                        <div class="address-detail">{{ address.fullAddress }}</div>
                    </div>
                    
                    <div class="address-actions">
                        <el-button 
                            v-if="address.isDefault !== 1"
                            size="small" 
                            @click.stop="setDefault(address.id)">
                            设为默认
                        </el-button>
                        <el-button 
                            size="small" 
                            type="primary"
                            @click.stop="editAddress(address)">
                            编辑
                        </el-button>
                        <el-button 
                            size="small" 
                            type="danger"
                            @click.stop="deleteAddress(address.id)">
                            删除
                        </el-button>
                    </div>
                </div>
            </div>

            <!-- 空状态 -->
            <div v-else class="empty-state">
                <div class="empty-icon">
                    <i class="el-icon-location"></i>
                </div>
                <div class="empty-text">暂无收货地址</div>
            </div>
        </div>

        <!-- 添加/编辑地址对话框 -->
        <el-dialog 
            v-model="dialogVisible" 
            :title="isEdit ? '编辑地址' : '添加新地址'"
            width="600px"
            :close-on-click-modal="false">
            
            <el-form :model="addressForm" :rules="formRules" ref="addressFormRef" label-width="100px">
                <el-form-item label="收货人" prop="receiverName">
                    <el-input v-model="addressForm.receiverName" placeholder="请输入收货人姓名"></el-input>
                </el-form-item>
                
                <el-form-item label="联系电话" prop="receiverPhone">
                    <el-input v-model="addressForm.receiverPhone" placeholder="请输入联系电话"></el-input>
                </el-form-item>
                
                <el-form-item label="所在地区" prop="region">
                    <el-input 
                        v-model="addressForm.province" 
                        placeholder="省份"
                        style="width: 32%; margin-right: 2%;">
                    </el-input>
                    <el-input 
                        v-model="addressForm.city" 
                        placeholder="城市"
                        style="width: 32%; margin-right: 2%;">
                    </el-input>
                    <el-input 
                        v-model="addressForm.district" 
                        placeholder="区县"
                        style="width: 32%;">
                    </el-input>
                </el-form-item>
                
                <el-form-item label="详细地址" prop="detailAddress">
                    <el-input 
                        v-model="addressForm.detailAddress" 
                        type="textarea"
                        :rows="3"
                        placeholder="请输入详细地址（街道、楼号、门牌号等）">
                    </el-input>
                </el-form-item>
                
                <el-form-item label="地址标签">
                    <el-radio-group v-model="addressForm.tag">
                        <el-radio label="家">家</el-radio>
                        <el-radio label="公司">公司</el-radio>
                        <el-radio label="学校">学校</el-radio>
                        <el-radio :label="null">无</el-radio>
                    </el-radio-group>
                </el-form-item>
                
                <el-form-item label="默认地址">
                    <el-switch v-model="addressForm.isDefault" :active-value="1" :inactive-value="0"></el-switch>
                </el-form-item>
            </el-form>
            
            <template #footer>
                <span class="dialog-footer">
                    <el-button @click="dialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="saveAddress" :loading="saving">
                        保存
                    </el-button>
                </span>
            </template>
        </el-dialog>
    </div>

    <!-- Element UI JS -->
    <script src="/js/vue.js"></script>
    <script src="/js/element-plus.js"></script>
    <script src="/js/axios.js"></script>
    
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        
        createApp({
            data() {
                return {
                    isLoggedIn: false,
                    userInfo: {},
                    addresses: [],
                    dialogVisible: false,
                    isEdit: false,
                    saving: false,
                    unreadCount: 0,
                    addressForm: {
                        id: null,
                        receiverName: '',
                        receiverPhone: '',
                        province: '',
                        city: '',
                        district: '',
                        detailAddress: '',
                        tag: null,
                        isDefault: 0
                    },
                    formRules: {
                        receiverName: [
                            { required: true, message: '请输入收货人姓名', trigger: 'blur' }
                        ],
                        receiverPhone: [
                            { required: true, message: '请输入联系电话', trigger: 'blur' },
                            { pattern: /^1[3-9]\d{9}$/, message: '请输入正确的手机号码', trigger: 'blur' }
                        ],
                        detailAddress: [
                            { required: true, message: '请输入详细地址', trigger: 'blur' }
                        ]
                    }
                };
            },
            mounted() {
                this.setupAxiosInterceptors();
                this.checkLoginStatus();
                if (this.isLoggedIn) {
                    this.loadAddresses();
                    this.loadUnreadCount();
                }
            },
            methods: {
                // 设置axios拦截器 - 自动添加Authorization头并处理401
                setupAxiosInterceptors() {
                    axios.interceptors.request.use(
                        config => {
                            const token = localStorage.getItem('accessToken');
                            if (token) {
                                config.headers.Authorization = `Bearer ${token}`;
                            }
                            return config;
                        },
                        error => Promise.reject(error)
                    );

                    axios.interceptors.response.use(
                        response => response,
                        async error => {
                            if (error.response && error.response.status === 401) {
                                try {
                                    const refreshToken = localStorage.getItem('refreshToken');
                                    if (refreshToken) {
                                        // 可在此实现刷新token逻辑（若项目已提供刷新接口）
                                    }
                                } catch (_) {}
                                window.location.href = '/auction/login';
                            }
                            return Promise.reject(error);
                        }
                    );
                },
                
                // 检查登录状态
                checkLoginStatus() {
                    const accessToken = localStorage.getItem('accessToken');
                    const refreshToken = localStorage.getItem('refreshToken');
                    const userInfoStr = localStorage.getItem('userInfo');
                    
                    if (accessToken && refreshToken) {
                        this.isLoggedIn = true;
                        if (userInfoStr) {
                            this.userInfo = JSON.parse(userInfoStr);
                        } else {
                            this.userInfo = { username: 'buyer1', nickname: '买家1' };
                        }
                    } else {
                        this.isLoggedIn = false;
                        this.userInfo = {};
                    }
                },
                
                // 加载地址列表
                loadAddresses() {
                    axios.get('/api/user/addresses/list')
                        .then(response => {
                            if (response.data.code === 200) {
                                this.addresses = response.data.data || [];
                            } else {
                                ElMessage.error(response.data.message || '加载地址列表失败');
                            }
                        })
                        .catch(error => {
                            console.error('加载地址列表失败:', error);
                            ElMessage.error('加载地址列表失败');
                        });
                },
                
                // 加载未读消息数
                loadUnreadCount() {
                    axios.get('/api/notifications/unread-count')
                        .then(response => {
                            if (response.data.code === 200) {
                                this.unreadCount = response.data.data || 0;
                            }
                        })
                        .catch(error => {
                            console.error('加载未读消息数失败:', error);
                        });
                },
                
                // 显示添加对话框
                showAddDialog() {
                    this.isEdit = false;
                    this.resetForm();
                    this.dialogVisible = true;
                },
                
                // 编辑地址
                editAddress(address) {
                    this.isEdit = true;
                    this.addressForm = {
                        id: address.id,
                        receiverName: address.receiverName,
                        receiverPhone: address.receiverPhone,
                        province: address.province || '',
                        city: address.city || '',
                        district: address.district || '',
                        detailAddress: address.detailAddress,
                        tag: address.tag,
                        isDefault: address.isDefault
                    };
                    this.dialogVisible = true;
                },
                
                // 保存地址
                saveAddress() {
                    this.$refs.addressFormRef.validate((valid) => {
                        if (valid) {
                            this.saving = true;
                            const url = this.isEdit ? '/api/user/addresses/update' : '/api/user/addresses/add';
                            const method = this.isEdit ? 'put' : 'post';
                            
                            axios({
                                method: method,
                                url: url,
                                data: this.addressForm
                            })
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success(this.isEdit ? '更新成功' : '添加成功');
                                    this.dialogVisible = false;
                                    this.loadAddresses();
                                } else {
                                    ElMessage.error(response.data.message || '操作失败');
                                }
                            })
                            .catch(error => {
                                console.error('保存地址失败:', error);
                                ElMessage.error('操作失败，请稍后重试');
                            })
                            .finally(() => {
                                this.saving = false;
                            });
                        }
                    });
                },
                
                // 设置默认地址
                setDefault(id) {
                    axios.post(`/api/user/addresses/${id}/default`)
                        .then(response => {
                            if (response.data.code === 200) {
                                ElMessage.success('设置成功');
                                this.loadAddresses();
                            } else {
                                ElMessage.error(response.data.message || '设置失败');
                            }
                        })
                        .catch(error => {
                            console.error('设置默认地址失败:', error);
                            ElMessage.error('设置失败，请稍后重试');
                        });
                },
                
                // 删除地址
                deleteAddress(id) {
                    ElMessageBox.confirm(
                        '确定要删除这个地址吗？',
                        '提示',
                        {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        }
                    ).then(() => {
                        axios.delete(`/api/user/addresses/${id}`)
                            .then(response => {
                                if (response.data.code === 200) {
                                    ElMessage.success('删除成功');
                                    this.loadAddresses();
                                } else {
                                    ElMessage.error(response.data.message || '删除失败');
                                }
                            })
                            .catch(error => {
                                console.error('删除地址失败:', error);
                                ElMessage.error('删除失败，请稍后重试');
                            });
                    }).catch(() => {
                        // 用户取消
                    });
                },
                
                // 重置表单
                resetForm() {
                    this.addressForm = {
                        id: null,
                        receiverName: '',
                        receiverPhone: '',
                        province: '',
                        city: '',
                        district: '',
                        detailAddress: '',
                        tag: null,
                        isDefault: 0
                    };
                    if (this.$refs.addressFormRef) {
                        this.$refs.addressFormRef.resetFields();
                    }
                },
                
                // 导航方法
                goToSessions() {
                    window.location.href = '/auction/user/sessions';
                },
                goToOrders() {
                    window.location.href = '/auction/user/orders';
                },
                goToDeposits() {
                    window.location.href = '/auction/user/deposits';
                },
                goToNotifications() {
                    window.location.href = '/auction/user/notifications';
                },
                
                // 跳转到登录页
                goToLogin() {
                    window.location.href = '/auction/login';
                },
                
                // 退出登录
                logout() {
                    ElMessageBox.confirm('确定要退出登录吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        axios.post('/api/auth/logout')
                            .then(() => {
                                window.location.href = '/auction/login';
                            })
                            .catch(error => {
                                console.error('退出登录失败:', error);
                                window.location.href = '/auction/login';
                            });
                    }).catch(() => {
                        // 用户取消
                    });
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>


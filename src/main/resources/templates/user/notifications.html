<!DOCTYPE html>
<!-- 
    ========================================
    文件名: notifications.html
    功能: 拍卖系统用户端 - 我的通知页面
    说明: 
    1. 显示用户的所有系统通知
    2. 支持按通知类型筛选（竞拍通知、订单通知、系统通知等）
    3. 未读通知有特殊标记（蓝色圆点和浅蓝背景）
    4. 支持标记已读和全部已读功能
    5. 支持删除通知
    6. 不同类型通知有不同的图标和颜色
    ========================================
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 设置视口，确保在移动设备上正确显示 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的通知 - 拍卖系统</title>
    
    <!-- 引入Element Plus UI组件库的CSS样式 -->
    <link rel="stylesheet" href="/css/element-plus.css">
    
    <!-- ========================= 自定义样式开始 ========================= -->
    <style>
        /* ----- 全局样式 ----- */
        /* 页面主体：无边距，浅灰色背景 */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        /* ----- 顶部导航栏 ----- */
        /* 导航栏：固定在顶部，白色背景 */
        .header {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: sticky;  /* 粘性定位，滚动时保持在顶部 */
            top: 0;
            z-index: 1000;  /* 高层级 */
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
            cursor: pointer;
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 28px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* ----- 主内容区域样式 ----- */
        /*
         * 主内容容器
         * 功能：包含页面主要内容
         * 布局：最大宽度1200px，居中显示
         */
        .main-content {
            max-width: 1200px;   /* 最大宽度 */
            margin: 20px auto;   /* 上下20px，左右居中 */
            padding: 0 20px;     /* 左右内边距 */
        }
        
        /* ----- 页面头部样式 ----- */
        /*
         * 页面头部卡片
         * 功能：显示页面标题和操作按钮
         * 布局：Flexbox左右分布
         */
        .page-header {
            background: white;                           /* 白色背景 */
            padding: 20px;                               /* 内边距 */
            border-radius: 8px;                          /* 圆角 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);   /* 阴影 */
            margin-bottom: 20px;                         /* 底部间距 */
            display: flex;                               /* Flexbox布局 */
            justify-content: space-between;              /* 左右两端对齐 */
            align-items: center;                         /* 垂直居中 */
        }
        
        /*
         * 页面标题
         * 样式：大号粗体深灰色
         */
        .page-title {
            font-size: 24px;      /* 字号24px */
            font-weight: bold;    /* 粗体 */
            color: #303133;       /* 深灰色 */
            margin: 0;            /* 无边距 */
        }
        
        /* ----- 通知列表样式 ----- */
        /*
         * 通知列表卡片
         * 功能：包含所有通知项的白色卡片
         */
        .notification-card {
            background: white;                           /* 白色背景 */
            border-radius: 8px;                          /* 圆角 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);   /* 阴影 */
        }
        
        /*
         * 通知项
         * 功能：单个通知的容器
         * 特点：
         * - 底部边框分隔
         * - 可点击（cursor: pointer）
         * - 悬停时背景变色
         * - 0.3秒过渡动画
         */
        .notification-item {
            padding: 20px;                       /* 内边距 */
            border-bottom: 1px solid #EBEEF5;    /* 底部分隔线 */
            cursor: pointer;                     /* 鼠标变为手型 */
            transition: background-color 0.3s;   /* 背景色过渡动画 */
            position: relative;                  /* 相对定位（用于::before伪元素） */
        }
        
        /*
         * 最后一个通知项：移除底部边框
         */
        .notification-item:last-child {
            border-bottom: none;
        }
        
        /*
         * 通知项悬停效果
         * 效果：背景变为浅灰色
         */
        .notification-item:hover {
            background-color: #F5F7FA;  /* 浅灰色背景 */
        }
        
        /*
         * 未读通知样式
         * 特点：浅蓝色背景，有蓝色圆点标记
         */
        .notification-item.unread {
            background-color: #F0F9FF;  /* 浅蓝色背景 */
        }
        
        /*
         * 未读通知标记：蓝色圆点
         * 实现：使用::before伪元素
         * 位置：左侧垂直居中
         */
        .notification-item.unread::before {
            content: '';                          /* 空内容 */
            position: absolute;                   /* 绝对定位 */
            left: 8px;                            /* 距左边8px */
            top: 50%;                             /* 距顶部50% */
            transform: translateY(-50%);          /* 垂直居中 */
            width: 8px;                           /* 宽度8px */
            height: 8px;                          /* 高度8px */
            background-color: #409EFF;            /* 蓝色 */
            border-radius: 50%;                   /* 圆形 */
        }
        
        /*
         * 通知头部
         * 功能：包含通知类型图标和时间
         * 布局：Flexbox左右分布
         */
        .notification-header {
            display: flex;                   /* Flexbox布局 */
            justify-content: space-between;  /* 左右两端对齐 */
            align-items: flex-start;         /* 顶部对齐 */
            margin-bottom: 10px;             /* 底部间距 */
        }
        
        /* ----- 通知类型图标样式 ----- */
        /*
         * 通知类型图标
         * 功能：显示通知类型的图标
         * 样式：圆形，40x40px，不同类型不同颜色
         */
        .notification-type-icon {
            display: inline-flex;              /* 行内Flex布局 */
            align-items: center;               /* 垂直居中 */
            justify-content: center;           /* 水平居中 */
            width: 40px;                       /* 宽度40px */
            height: 40px;                      /* 高度40px */
            border-radius: 50%;                /* 圆形 */
            margin-right: 12px;                /* 右侧间距 */
        }
        
        /*
         * 不同类型通知的颜色
         * type-1：竞拍通知（红色）
         * type-2：订单通知（蓝色）
         * type-3：系统通知（蓝色）
         * type-4：保证金通知（橙色）
         * type-5：其他通知（灰色）
         */
        .notification-type-1 { background-color: #FEF0F0; color: #F56C6C; }  /* 红色 */
        .notification-type-2 { background-color: #F0F9FF; color: #409EFF; }  /* 蓝色 */
        .notification-type-3 { background-color: #F0F9FF; color: #409EFF; }  /* 蓝色 */
        .notification-type-4 { background-color: #FDF6EC; color: #E6A23C; }  /* 橙色 */
        .notification-type-5 { background-color: #F4F4F5; color: #909399; }  /* 灰色 */
        
        /*
         * 通知内容包装器
         * 功能：包含通知标题和内容
         * 布局：占据剩余空间
         */
        .notification-content-wrapper {
            flex: 1;  /* 占据剩余空间 */
        }
        
        .notification-title {
            font-size: 16px;
            font-weight: bold;
            color: #303133;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .notification-content {
            font-size: 14px;
            color: #606266;
            line-height: 1.6;
            margin-bottom: 8px;
        }
        
        .notification-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #909399;
        }
        
        .notification-time {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .notification-actions {
            display: flex;
            gap: 10px;
        }
        
        .empty-notification {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        
        .empty-notification i {
            font-size: 64px;
            margin-bottom: 20px;
            display: block;
        }
        
        .pagination-container {
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 顶部导航 -->
        <el-header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="el-icon-gavel"></i>
                    <span>拍卖系统</span>
                </div>
                <div class="nav-links">
                    <el-link href="/auction/user/sessions" :underline="false">拍卖会</el-link>
                    <el-link href="/auction/user/orders" :underline="false">我的订单</el-link>
                    <el-link href="/auction/user/deposits" :underline="false">保证金</el-link>
                    <el-link href="/auction/user/addresses" :underline="false">收货地址</el-link>
                    <el-link :underline="false" disabled style="font-weight: bold; color: #409EFF; cursor: not-allowed;">我的通知</el-link>
                </div>
                <div class="user-info" v-if="isLoggedIn">
                    <el-badge :value="unreadCount" :hidden="unreadCount === 0" style="margin-right: 15px;">
                        <el-button icon="el-icon-bell" circle @click="goToNotifications"></el-button>
                    </el-badge>
                    <span>欢迎，{{ currentUser.nickname || currentUser.username }}</span>
                    <el-button @click="logout" type="danger" size="small">退出登录</el-button>
                </div>
                <div class="user-info" v-else>
                    <el-button @click="goToLogin" type="primary" size="small">登录</el-button>
                </div>
            </div>
        </el-header>

        <!-- 主内容 -->
        <div class="main-content">
            <!-- 页面头部 -->
            <div class="page-header">
                <div>
                    <h1 class="page-title">
                        <i class="el-icon-bell"></i>
                        我的通知
                    </h1>
                    <p class="page-description" v-if="unreadCount > 0">
                        您有 <el-tag type="danger" size="small">{{ unreadCount }}</el-tag> 条未读通知
                    </p>
                </div>
                <el-button v-if="unreadCount > 0" type="primary" size="small" @click="markAllAsRead">
                    <i class="el-icon-check"></i>
                    全部已读
                </el-button>
            </div>

            <!-- 通知列表 -->
            <div class="notification-card" v-loading="loading">
                <div v-if="notifications.length > 0">
                    <div 
                        v-for="notification in notifications" 
                        :key="notification.id"
                        :class="['notification-item', notification.isRead === 0 ? 'unread' : '']"
                        @click="handleNotificationClick(notification)">
                        
                        <div style="display: flex;">
                            <!-- 通知类型图标 -->
                            <div :class="['notification-type-icon', `notification-type-${notification.notificationType}`]">
                                <i :class="getNotificationIcon(notification.notificationType)" style="font-size: 20px;"></i>
                            </div>
                            
                            <!-- 通知内容 -->
                            <div class="notification-content-wrapper">
                                <div class="notification-header">
                                    <div class="notification-title">
                                        {{ notification.title }}
                                        <el-tag v-if="notification.isRead === 0" type="danger" size="small">未读</el-tag>
                                    </div>
                                </div>
                                
                                <div class="notification-content">
                                    {{ notification.content }}
                                </div>
                                
                                <div class="notification-footer">
                                    <div class="notification-time">
                                        <i class="el-icon-time"></i>
                                        {{ formatTime(notification.createTime) }}
                                    </div>
                                    <div class="notification-actions" @click.stop>
                                        <el-button 
                                            v-if="notification.isRead === 0" 
                                            type="text" 
                                            size="small" 
                                            @click="markAsRead(notification.id)">
                                            标记已读
                                        </el-button>
                                        <el-button 
                                            type="text" 
                                            size="small" 
                                            @click="deleteNotification(notification.id)">
                                            删除
                                        </el-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 空状态 -->
                <div v-else class="empty-notification">
                    <i class="el-icon-bell"></i>
                    <p>暂无通知</p>
                </div>
            </div>

            <!-- 分页 -->
            <div class="pagination-container" v-if="total > pageSize">
                <el-pagination
                    v-model:current-page="pageNum"
                    v-model:page-size="pageSize"
                    :page-sizes="[10, 20, 50, 100]"
                    :total="total"
                    layout="total, sizes, prev, pager, next"
                    @size-change="loadNotifications"
                    @current-change="loadNotifications">
                </el-pagination>
            </div>
        </div>
    </div>

    <!-- Vue 3 -->
    <script src="/js/vue.js"></script>
    <!-- Element Plus -->
    <script src="/js/element-plus.js"></script>
    <!-- Axios -->
    <script src="/js/axios.js"></script>
    
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        
        createApp({
            data() {
                return {
                    isLoggedIn: false,
                    currentUser: {},
                    notifications: [],
                    unreadCount: 0,
                    loading: false,
                    pageNum: 1,
                    pageSize: 20,
                    total: 0
                };
            },
            
            mounted() {
                this.setupAxiosInterceptors();
                this.checkLogin();
                if (this.isLoggedIn) {
                    this.loadNotifications();
                    // 每30秒刷新一次未读数
                    setInterval(() => {
                        this.loadUnreadCount();
                    }, 30000);
                }
            },
            
            methods: {
                setupAxiosInterceptors() {
                    axios.interceptors.request.use(
                        config => {
                            const token = localStorage.getItem('accessToken');
                            if (token) {
                                config.headers.Authorization = `Bearer ${token}`;
                            }
                            return config;
                        },
                        error => {
                            return Promise.reject(error);
                        }
                    );
                    
                    axios.interceptors.response.use(
                        response => response,
                        async error => {
                            if (error.response && error.response.status === 401) {
                                const refreshToken = localStorage.getItem('refreshToken');
                                if (refreshToken) {
                                    try {
                                        const response = await axios.post('/api/auth/refresh', {
                                            refreshToken: refreshToken
                                        });
                                        
                                        if (response.data.code === 200) {
                                            const newAccessToken = response.data.data.accessToken;
                                            localStorage.setItem('accessToken', newAccessToken);
                                            error.config.headers.Authorization = `Bearer ${newAccessToken}`;
                                            return axios.request(error.config);
                                        }
                                    } catch (refreshError) {
                                        console.error('Token刷新失败:', refreshError);
                                    }
                                }
                                
                                localStorage.removeItem('accessToken');
                                localStorage.removeItem('refreshToken');
                                localStorage.removeItem('userInfo');
                                this.isLoggedIn = false;
                                this.currentUser = {};
                                ElMessage.error('登录已过期，请重新登录');
                                window.location.href = '/auction/login';
                            }
                            return Promise.reject(error);
                        }
                    );
                },
                
                async checkLogin() {
                    const accessToken = localStorage.getItem('accessToken');
                    const refreshToken = localStorage.getItem('refreshToken');
                    const userInfoStr = localStorage.getItem('userInfo');
                    
                    if (accessToken && refreshToken) {
                        this.isLoggedIn = true;
                        if (userInfoStr) {
                            this.currentUser = JSON.parse(userInfoStr);
                        } else {
                            this.currentUser = {
                                username: 'buyer1',
                                nickname: '买家1'
                            };
                        }
                    } else {
                        this.isLoggedIn = false;
                        ElMessage.warning('请先登录');
                        window.location.href = '/auction/login';
                    }
                },
                
                async loadNotifications() {
                    this.loading = true;
                    try {
                        const response = await axios.get('/api/notifications', {
                            params: {
                                pageNum: this.pageNum,
                                pageSize: this.pageSize
                            }
                        });
                        
                        if (response.data.code === 200) {
                            const data = response.data.data;
                            this.notifications = data.list || [];
                            this.unreadCount = data.unreadCount || 0;
                            this.total = data.list.length;
                        }
                    } catch (error) {
                        console.error('加载通知失败:', error);
                        ElMessage.error('加载通知失败');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async loadUnreadCount() {
                    try {
                        const response = await axios.get('/api/notifications/unread-count');
                        if (response.data.code === 200) {
                            this.unreadCount = response.data.data;
                        }
                    } catch (error) {
                        console.error('获取未读数失败:', error);
                    }
                },
                
                async markAsRead(id) {
                    try {
                        const response = await axios.put(`/api/notifications/${id}/read`);
                        if (response.data.code === 200) {
                            ElMessage.success('已标记为已读');
                            this.loadNotifications();
                        }
                    } catch (error) {
                        console.error('标记已读失败:', error);
                        ElMessage.error('操作失败');
                    }
                },
                
                async markAllAsRead() {
                    try {
                        const response = await axios.put('/api/notifications/read-all');
                        if (response.data.code === 200) {
                            ElMessage.success('全部标记为已读');
                            this.loadNotifications();
                        }
                    } catch (error) {
                        console.error('全部标记已读失败:', error);
                        ElMessage.error('操作失败');
                    }
                },
                
                async deleteNotification(id) {
                    try {
                        await ElMessageBox.confirm('确定要删除这条通知吗？', '删除确认', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        const response = await axios.delete(`/api/notifications/${id}`);
                        if (response.data.code === 200) {
                            ElMessage.success('删除成功');
                            this.loadNotifications();
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('删除通知失败:', error);
                            ElMessage.error('删除失败');
                        }
                    }
                },
                
                async handleNotificationClick(notification) {
                    // 如果未读，先标记为已读
                    if (notification.isRead === 0) {
                        await this.markAsRead(notification.id);
                    }
                    
                    // 如果有跳转链接，进行跳转
                    if (notification.linkUrl) {
                        if (notification.relatedType === 'order' && notification.relatedId) {
                            window.location.href = `/auction/user/orders`;
                        } else {
                            window.location.href = notification.linkUrl;
                        }
                    }
                },
                
                getNotificationIcon(type) {
                    const icons = {
                        1: 'el-icon-trophy',      // 中标通知
                        2: 'el-icon-shopping-cart', // 订单通知
                        3: 'el-icon-wallet',       // 支付通知
                        4: 'el-icon-truck',        // 发货通知
                        5: 'el-icon-bell'          // 系统通知
                    };
                    return icons[type] || 'el-icon-bell';
                },
                
                formatTime(time) {
                    if (!time) return '';
                    const date = new Date(time);
                    const now = new Date();
                    const diff = now - date;
                    
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000);
                    const days = Math.floor(diff / 86400000);
                    
                    if (minutes < 1) return '刚刚';
                    if (minutes < 60) return `${minutes}分钟前`;
                    if (hours < 24) return `${hours}小时前`;
                    if (days < 7) return `${days}天前`;
                    
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },
                
                goToHome() {
                    window.location.href = '/auction/user/sessions';
                },
                
                goToNotifications() {
                    window.location.href = '/auction/user/notifications';
                },
                
                goToLogin() {
                    window.location.href = '/auction/login';
                },
                
                goToRegister() {
                    window.location.href = '/auction/user/register';
                },
                
                async logout() {
                    try {
                        await ElMessageBox.confirm('确定要退出登录吗？', '提示', {
                            confirmButtonText: '确定',
                            cancelButtonText: '取消',
                            type: 'warning'
                        });
                        
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userInfo');
                        
                        await axios.post('/api/auth/logout').catch(() => {});
                        
                        this.isLoggedIn = false;
                        this.currentUser = {};
                        ElMessage.success('已退出登录');
                        window.location.href = '/auction/login';
                    } catch (error) {
                        if (error !== 'cancel') {
                            console.error('退出登录失败:', error);
                        }
                    }
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>


<!DOCTYPE html>
<!-- 
    ========================================
    文件名: session-detail.html
    功能: 拍卖系统用户端 - 拍卖会详情页
    说明: 
    1. 显示拍卖会的详细信息（名称、描述、规则、时间等）
    2. 显示拍卖会的统计数据（拍品数、围观人数、保证金比例等）
    3. 显示拍卖会包含的所有拍品列表
    4. 支持拍品搜索和排序功能
    5. 支持图片轮播展示拍卖会封面
    6. 点击拍品可跳转到竞拍页面
    ========================================
-->
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>拍卖会详情 - 拍卖系统</title>
    <link rel="stylesheet" href="/css/element-plus.css">
    
    <!-- ========================= 自定义样式开始 ========================= -->
    <style>
        /* ----- 全局样式 ----- */
        /* 页面主体：无边距，浅灰色背景，中文友好字体 */
        body { margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif; background-color: #f5f5f5; }
        
        /* 顶部导航栏：白色背景，固定在顶部 */
        .header { background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); padding: 0 20px; position: sticky; top: 0; z-index: 1000; }
        
        /* 导航栏内容：Flexbox布局，左右分布 */
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; height: 60px; }
        
        /* Logo区域：图标+文字 */
        .logo { display: flex; align-items: center; font-size: 24px; font-weight: bold; color: #409EFF; }
        
        /* 导航链接：横向排列 */
        .nav-links { display: flex; gap: 20px; }
        
        /* 主内容区：最大宽度1200px，居中 */
        .main { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        /* ----- 拍卖会信息展示区域 ----- */
        /* 拍卖会信息区：Grid两列布局，左侧360px固定宽度显示图片，右侧自适应显示信息 */
        .session-hero { display: grid; grid-template-columns: 360px 1fr; gap: 20px; margin-bottom: 20px; }
        
        /* 信息卡片：白色背景，圆角，阴影 */
        .hero-card { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
        
        /* ----- 图片轮播区域样式 ----- */
        /* 图片容器：固定高度240px，超出隐藏 */
        .hero-image-container { position: relative; width: 100%; height: 240px; overflow: hidden; background: #f5f5f5; }
        
        /* 轮播图片：默认隐藏，只显示active的 */
        .hero-image { width: 100%; height: 240px; object-fit: cover; display: none; }
        .hero-image.active { display: block; }  /* 当前显示的图片 */
        
        /* 轮播箭头按钮：左右切换按钮 */
        .session-carousel-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0, 0, 0, 0.5); color: white; border: none; font-size: 30px; width: 40px; height: 40px; cursor: pointer; z-index: 10; transition: background 0.3s; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        .session-carousel-arrow:hover { background: rgba(0, 0, 0, 0.8); }  /* 悬停时背景变深 */
        .session-carousel-arrow.left { left: 5px; }   /* 左箭头位置 */
        .session-carousel-arrow.right { right: 5px; } /* 右箭头位置 */
        
        /* 轮播指示器：底部圆点，显示当前是第几张图 */
        .session-carousel-indicators { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 10; }
        .session-carousel-indicator { width: 8px; height: 8px; border-radius: 50%; background: rgba(255, 255, 255, 0.5); cursor: pointer; transition: background 0.3s; }
        .session-carousel-indicator.active { background: rgba(255, 255, 255, 1); }  /* 当前图片的指示器为白色 */
        
        /* ----- 拍卖会信息内容样式 ----- */
        /* 内容区域：包含标题、描述、统计数据 */
        .hero-content { padding: 20px; }
        
        /* 拍卖会标题：大号字体，深灰色 */
        .hero-title { margin: 0 0 8px 0; font-size: 22px; color: #303133; }
        
        /* 拍卖会描述：中灰色，行高1.6增加可读性 */
        .hero-desc { margin: 0 0 12px 0; color: #606266; line-height: 1.6; }
        
        /* 统计数据网格：3列等宽布局 */
        .hero-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        /* 单个统计项：浅灰色背景，圆角，居中对齐 */
        .hero-item { background: #f8f9fa; border-radius: 8px; padding: 12px; text-align: center; }
        .hero-item .label { font-size: 12px; color: #909399; }  /* 标签：小号灰色字体 */
        .hero-item .value { margin-top: 4px; font-weight: bold; color: #303133; }  /* 数值：粗体深灰色 */
        
        /* ----- 拍品列表区域样式 ----- */
        /* 拍品列表卡片：白色背景卡片 */
        .items-card { background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; }
        
        /* 拍品网格：自适应列数，每列最小280px */
        .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        
        /* ----- 拍品卡片样式 ----- */
        /* 拍品卡片：边框，圆角，悬停效果 */
        .item-card { border: 1px solid #ebeef5; border-radius: 8px; overflow: hidden; transition: .2s; background: #fff; }
        .item-card:hover { box-shadow: 0 6px 18px rgba(0,0,0,0.08); transform: translateY(-2px); }  /* 悬停时上浮 */
        
        /* 拍品图片：固定高度180px，保持比例裁剪 */
        .item-img { width: 100%; height: 180px; object-fit: cover; display: block; }
        
        /* 拍品信息区域：内边距12px */
        .item-body { padding: 12px; }
        
        /* 拍品标题：单行显示，超出显示省略号 */
        .item-title { margin: 0 0 6px 0; font-size: 16px; color: #303133; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* 拍品描述：最多2行，高度32px，超出隐藏 */
        .item-desc { margin: 0 0 10px 0; font-size: 12px; color: #909399; height: 32px; overflow: hidden; }
        
        /* 拍品元数据网格：2列布局 */
        .item-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        
        /* 元数据项：浅灰色背景，圆角，居中 */
        .meta { background: #f8f9fa; border-radius: 6px; padding: 8px; text-align: center; }
        .meta .label { font-size: 12px; color: #909399; }  /* 标签 */
        .meta .value { margin-top: 4px; font-weight: bold; color: #f56c6c; }  /* 价格：红色粗体 */
        
        /* 拍品操作按钮区：横向排列 */
        .item-actions { display: flex; gap: 8px; }
    </style>
    <!-- ========================= 自定义样式结束 ========================= -->
    </head>
<body>
    <div id="app">
        <el-header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="el-icon-gavel"></i>
                    <span>拍卖系统</span>
                </div>
                <div class="nav-links">
                    <el-link :underline="false" disabled style="font-weight: bold; color: #409EFF; cursor: not-allowed;">拍卖会</el-link>
                    <el-link href="/auction/user/orders" :underline="false">我的订单</el-link>
                    <el-link href="/auction/user/deposits" :underline="false">保证金</el-link>
                    <el-link href="/auction/user/addresses" :underline="false">收货地址</el-link>
                    <el-link href="/auction/user/notifications" :underline="false">我的通知</el-link>
                </div>
                <div class="user-info" v-if="isLoggedIn">
                    <el-badge :value="unreadNotifications" :hidden="unreadNotifications === 0" style="margin-right: 15px;">
                        <el-button icon="el-icon-bell" circle @click="goToNotifications"></el-button>
                    </el-badge>
                    <span>欢迎，{{ userInfo.nickname || userInfo.username }}</span>
                    <el-button @click="logout" type="danger" size="small">退出登录</el-button>
                </div>
                <div class="user-info" v-else>
                    <el-button @click="goToLogin" type="primary" size="small">登录</el-button>
                </div>
            </div>
        </el-header>

        <el-main class="main">
            <!-- 会场信息 -->
            <div class="session-hero">
                <div class="hero-card">
                    <!-- 拍卖会图片轮播 -->
                    <div class="hero-image-container">
                        <img 
                            v-for="(img, index) in sessionImages" 
                            :key="index"
                            :src="img" 
                            :alt="session.sessionName" 
                            class="hero-image"
                            :class="{ active: index === sessionImageIndex }">
                        <button class="session-carousel-arrow left" @click="previousSessionImage" v-if="sessionImages.length > 1">‹</button>
                        <button class="session-carousel-arrow right" @click="nextSessionImage" v-if="sessionImages.length > 1">›</button>
                        <div class="session-carousel-indicators" v-if="sessionImages.length > 1">
                            <div 
                                v-for="(img, index) in sessionImages" 
                                :key="index"
                                class="session-carousel-indicator"
                                :class="{ active: index === sessionImageIndex }"
                                @click="goToSessionImage(index)">
                            </div>
                        </div>
                    </div>
                    <div class="hero-content">
                        <h2 class="hero-title">{{ session.sessionName }}</h2>
                        <p class="hero-desc">{{ session.description }}</p>
                        <div style="margin-top:8px; color:#606266; font-size:13px;">
                            <strong>拍卖规则：</strong>
                            <span>{{ session.rules || '—' }}</span>
                        </div>
                        <div class="hero-grid">
                            <div class="hero-item">
                                <div class="label">开始时间</div>
                                <div class="value">{{ formatTime(session.startTime) }}</div>
                            </div>
                            <div class="hero-item">
                                <div class="label">结束时间</div>
                                <div class="value">{{ formatTime(session.endTime) }}</div>
                            </div>
                            <div class="hero-item">
                                <div class="label">拍品数量</div>
                                <div class="value">{{ session.totalItems || (session.items ? session.items.length : 0) }}</div>
                            </div>
                            <div class="hero-item">
                                <div class="label">围观人数</div>
                                <div class="value">{{ (session.viewCount !== undefined && session.viewCount !== null) ? Number(session.viewCount) : 0 }}</div>
                            </div>
                            <div class="hero-item">
                                <div class="label">保证金比例</div>
                                <div class="value">{{ (session.depositRatio || 0) * 100 }}%</div>
                            </div>
                            <div class="hero-item">
                                <div class="label">佣金比例</div>
                                <div class="value">{{ (session.commissionRatio || 0) * 100 }}%</div>
                            </div>
                            <!-- 去除冗余字段：服务展示 -->
                        </div>
                    </div>
                </div>
                
            </div>

            <!-- 拍品列表 -->
            <div class="items-card">
                <div style="display:flex; align-items:center; justify-content:space-between; margin:0 0 12px 0;">
                    <h3 style="margin: 0;">拍品列表</h3>
                    <!-- 顶部固定可见的排序按钮（弹出层） -->
                    <el-popover placement="bottom-end" trigger="click" :append-to-body="true" popper-class="sort-popper-high">
                        <template #reference>
                            <el-button size="small" type="primary">排序</el-button>
                        </template>
                        <div style="display:flex; gap:6px; flex-wrap:wrap; max-width:320px;">
                            <el-button size="small" @click="sortField='itemCode'; sortOrder='desc'">编号 高→低</el-button>
                            <el-button size="small" @click="sortField='itemCode'; sortOrder='asc'">编号 低→高</el-button>
                            <el-button size="small" @click="sortField='startingPrice'; sortOrder='desc'">起拍价 高→低</el-button>
                            <el-button size="small" @click="sortField='startingPrice'; sortOrder='asc'">起拍价 低→高</el-button>
                            
                        </div>
                    </el-popover>
                </div>
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px; flex-wrap:wrap; background:#f8f9fa; border:1px solid #ebeef5; border-radius:8px; padding:10px;">
                    <el-input v-model="searchCode" placeholder="按拍品编号或名称搜索" size="small" clearable style="width: 280px;" />
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <span style="color:#606266;">排序字段</span>
                        <el-select v-model="sortField" size="small" style="width: 160px;">
                            <el-option label="拍品编号" value="itemCode" />
                            <el-option label="起拍价" value="startingPrice" />
                            
                        </el-select>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                        <span style="color:#606266;">排序方式</span>
                        <el-radio-group v-model="sortOrder" size="small">
                            <el-radio-button label="desc">从高到低</el-radio-button>
                            <el-radio-button label="asc">从低到高</el-radio-button>
                        </el-radio-group>
                    </div>
                    <!-- 弹出排序改移到标题右侧，避免被遮挡 -->
                </div>
                <div v-if="loading" style="text-align: center; padding: 20px;">
                    <el-icon class="is-loading"><Loading /></el-icon>
                    <p>加载中...</p>
                </div>
                <div v-else-if="!session.items || session.items.length === 0" style="text-align:center; color:#909399; padding: 30px;">暂无拍品</div>
                <div v-else class="items-grid">
                    <div v-for="it in filteredSortedItems" :key="it.id" class="item-card">
                        <img :src="extractFirstImage(it.images) || '/images/default-item.jpg'" class="item-img" :alt="it.itemName">
                        <div class="item-body">
                            <h4 class="item-title">{{ it.itemName }}</h4>
                            <div class="item-desc">{{ it.description }}</div>
                            <div class="item-meta">
                                <div class="meta">
                                    <div class="label">拍品编号</div>
                                    <div class="value" style="color:#303133;">{{ it.itemCode || '-' }}</div>
                                </div>
                                <div class="meta">
                                    <div class="label">起拍价</div>
                                    <div class="value">¥{{ toYuan(it.startingPrice) }}</div>
                                </div>
                                <div class="meta">
                                    <div class="label">当前价</div>
                                    <div class="value">¥{{ toYuan(it.currentPrice) }}</div>
                                </div>
                                
                            </div>
                            <div class="item-actions">
                                <el-button type="primary" @click="enterBidding(it.id)">进入实时竞价</el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </el-main>
    </div>

    <script src="/js/vue.js"></script>
    <script src="/js/element-plus.js"></script>
    <script src="/js/axios.js"></script>
    <script src="/js/api-init.js"></script>
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;
        const __app__factory = createApp({
            data() {
                return {
                    isLoggedIn: false,
                    userInfo: {},
                    unreadNotifications: 0,
                    loading: true,
                    session: {},
                    // 搜索与排序
                    searchCode: '',
                    sortField: 'itemCode',
                    sortOrder: 'asc',
                    // 轮播图
                    sessionImageIndex: 0
                }
            },
            mounted() {
                this.setupAxiosInterceptors();
                this.checkLoginStatus();
                if (this.isLoggedIn) {
                    this.loadSession();
                    this.loadUnreadNotifications();
                    // 每30秒刷新未读通知数
                    setInterval(() => {
                        if (this.isLoggedIn) {
                            this.loadUnreadNotifications();
                        }
                    }, 30000);
                }
            },
            methods: {
                setupAxiosInterceptors() {
                    axios.interceptors.request.use(
                        config => {
                            const token = localStorage.getItem('accessToken');
                            if (token) {
                                config.headers.Authorization = `Bearer ${token}`;
                            }
                            return config;
                        },
                        error => Promise.reject(error)
                    );
                    
                    axios.interceptors.response.use(
                        response => response,
                        async error => {
                            if (error.response && error.response.status === 401) {
                                const refreshToken = localStorage.getItem('refreshToken');
                                if (refreshToken) {
                                    try {
                                        const response = await axios.post('/api/auth/refresh', { refreshToken });
                                        if (response.data.code === 200) {
                                            const newAccessToken = response.data.data.accessToken;
                                            localStorage.setItem('accessToken', newAccessToken);
                                            error.config.headers.Authorization = `Bearer ${newAccessToken}`;
                                            return axios.request(error.config);
                                        }
                                    } catch (e) {
                                        console.error('Token刷新失败:', e);
                                    }
                                }
                                
                                localStorage.removeItem('accessToken');
                                localStorage.removeItem('refreshToken');
                                localStorage.removeItem('userInfo');
                                this.isLoggedIn = false;
                                this.userInfo = {};
                                ElMessage.error('登录已过期，请重新登录');
                                window.location.href = '/auction/login';
                            }
                            return Promise.reject(error);
                        }
                    );
                },
                
                checkLoginStatus() {
                    const accessToken = localStorage.getItem('accessToken');
                    const refreshToken = localStorage.getItem('refreshToken');
                    const userInfoStr = localStorage.getItem('userInfo');
                    
                    if (accessToken && refreshToken) {
                        this.isLoggedIn = true;
                        if (userInfoStr) {
                            this.userInfo = JSON.parse(userInfoStr);
                        } else {
                            this.userInfo = { username: 'buyer1', nickname: '买家1' };
                        }
                    } else {
                        this.isLoggedIn = false;
                        ElMessage.warning('请先登录');
                        window.location.href = '/auction/login';
                    }
                },
                
                async loadUnreadNotifications() {
                    try {
                        const response = await axios.get('/api/notifications/unread-count');
                        if (response.data.code === 200) {
                            this.unreadNotifications = response.data.data;
                        }
                    } catch (error) {
                        console.error('获取未读通知数失败:', error);
                    }
                },
                
                goToNotifications() {
                    window.location.href = '/auction/user/notifications';
                },
                getSessionId() {
                    const m = window.location.pathname.match(/\/sessions\/(\d+)/);
                    return m ? m[1] : null;
                },
                loadSession() {
                    const id = this.getSessionId();
                    if (!id) { this.loading = false; return; }
                    axios.get(`/api/user/sessions/${id}`)
                        .then(res => {
                            if (res.data.code === 200) {
                                this.session = res.data.data || {};
                                // 访问详情页即计一次围观
                                axios.post(`/api/user/sessions/${id}/view`).then(r => {
                                    if (r.data && r.data.code === 200) {
                                        // 使用返回的最新计数更新显示
                                        const c = Number(r.data.data || 0);
                                        this.session.viewCount = isNaN(c) ? (this.session.viewCount || 0) : c;
                                    }
                                }).catch(()=>{});
                            } else {
                                ElMessage.error('加载拍卖会失败');
                            }
                        })
                        .catch(e => {
                            console.error('加载拍卖会失败', e);
                            ElMessage.error('加载拍卖会失败');
                        })
                        .finally(() => this.loading = false);
                },
                formatTime(t) { return t ? new Date(t).toLocaleString('zh-CN') : '—'; },
                toYuan(v) { if (v == null) return 0; return typeof v === 'number' ? v : parseFloat(v); },
                extractFirstImage(images) {
                    if (!images) return null;
                    try {
                        const arr = JSON.parse(images);
                        return Array.isArray(arr) && arr.length > 0 ? arr[0] : null;
                    } catch (_) { return null; }
                },
                enterBidding(itemId) {
                    const id = this.getSessionId();
                    window.location.href = `/auction/user/sessions/${id}/bidding?itemId=${itemId}`;
                },
                goToLogin() { window.location.href = '/auction/login'; },
                logout() {
                    ElMessageBox.confirm('确定要退出登录吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        localStorage.removeItem('userInfo');
                        
                        axios.post('/api/auth/logout').finally(() => {
                            this.isLoggedIn = false;
                            this.userInfo = {};
                            ElMessage.success('已退出登录');
                            window.location.href = '/auction/login';
                        });
                    }).catch(() => {});
                },
                // 过滤与排序
                filteredSorted(items) {
                    let list = Array.isArray(items) ? items.slice() : [];
                    if (this.searchCode && this.searchCode.trim()) {
                        const key = this.searchCode.trim().toLowerCase();
                        list = list.filter(it => ((it.itemCode || '').toLowerCase().includes(key)) || ((it.itemName || '').toLowerCase().includes(key)));
                    }
                    const field = this.sortField;
                    const order = this.sortOrder === 'desc' ? -1 : 1;
                    const getVal = (it) => {
                        if (field === 'itemCode') return (it.itemCode || '').toString();
                        if (field === 'startingPrice') return Number(this.toYuan(it.startingPrice) || 0);
                        if (field === 'hammerPrice') return Number(this.toYuan(it.hammerPrice != null ? it.hammerPrice : it.currentPrice));
                        return 0;
                    };
                    list.sort((a, b) => {
                        const va = getVal(a), vb = getVal(b);
                        if (typeof va === 'string' && typeof vb === 'string') {
                            return va.localeCompare(vb) * order;
                        }
                        return (va - vb) * order;
                    });
                    return list;
                },
                
                // 拍卖会轮播图控制方法
                nextSessionImage() {
                    if (this.sessionImages.length > 0) {
                        this.sessionImageIndex = (this.sessionImageIndex + 1) % this.sessionImages.length;
                    }
                },
                
                previousSessionImage() {
                    if (this.sessionImages.length > 0) {
                        this.sessionImageIndex = (this.sessionImageIndex - 1 + this.sessionImages.length) % this.sessionImages.length;
                    }
                },
                
                goToSessionImage(index) {
                    this.sessionImageIndex = index;
                }
            },
            computed: {
                filteredSortedItems() {
                    return this.filteredSorted((this.session && this.session.items) ? this.session.items : []);
                },
                // 拍卖会图片数组
                sessionImages() {
                    // 优先使用 images 字段（JSON数组）
                    if (this.session && this.session.images) {
                        try {
                            const arr = JSON.parse(this.session.images);
                            if (Array.isArray(arr) && arr.length > 0) {
                                return arr;
                            }
                        } catch (e) {
                            console.error('解析拍卖会图片失败:', e);
                        }
                    }
                    // 其次使用 coverImage 字段
                    if (this.session && this.session.coverImage) {
                        return [this.session.coverImage];
                    }
                    // 最后使用默认图片
                    return ['/images/default-session.jpg'];
                }
            }
        }).use(ElementPlus);
        const __app__mounted = __app__factory.mount('#app');
        window.__app__ref = __app__mounted;
    </script>
</body>
</html>



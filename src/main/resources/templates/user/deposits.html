<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保证金管理 - 拍卖系统</title>
    
    <!-- Element UI CSS - 使用CDN -->
    <link rel="stylesheet" href="/css/element-plus.css">
    <!-- 自定义样式 -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        
        .header {
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 0 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            height: 60px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: #409EFF;
        }
        
        .logo i {
            margin-right: 10px;
            font-size: 28px;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: bold;
            color: #303133;
            margin: 0;
        }
        
        .page-description {
            color: #606266;
            margin: 10px 0 0 0;
        }
        
        .deposit-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .overview-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .overview-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        .overview-value {
            font-size: 32px;
            font-weight: bold;
            color: #303133;
            margin-bottom: 5px;
        }
        
        .overview-label {
            font-size: 14px;
            color: #909399;
        }
        
        .balance-card {
            border-left: 4px solid #409EFF;
        }
        
        .balance-icon {
            color: #409EFF;
        }
        
        .frozen-card {
            border-left: 4px solid #f56c6c;
        }
        
        .frozen-icon {
            color: #f56c6c;
        }
        
        .available-card {
            border-left: 4px solid #67c23a;
        }
        
        .available-icon {
            color: #67c23a;
        }
        
        .deposit-actions {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .action-title {
            font-size: 18px;
            font-weight: bold;
            color: #303133;
            margin: 0 0 20px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .action-btn {
            min-width: 120px;
        }
        
        .deposit-form {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .form-title {
            font-size: 18px;
            font-weight: bold;
            color: #303133;
            margin: 0 0 20px 0;
        }
        
        .quick-amounts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quick-amount-btn {
            padding: 10px;
            border: 1px solid #e4e7ed;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .quick-amount-btn:hover {
            border-color: #409EFF;
            color: #409EFF;
        }
        
        .quick-amount-btn.selected {
            border-color: #409EFF;
            background: #f0f9ff;
            color: #409EFF;
        }
        
        .transaction-history {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .history-title {
            font-size: 18px;
            font-weight: bold;
            color: #303133;
            margin: 0 0 20px 0;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-info {
            flex: 1;
        }
        
        .transaction-type {
            font-weight: bold;
            color: #303133;
            margin-bottom: 5px;
        }
        
        .transaction-desc {
            font-size: 14px;
            color: #606266;
        }
        
        .transaction-amount {
            font-size: 16px;
            font-weight: bold;
        }
        
        .amount-positive {
            color: #67c23a;
        }
        
        .amount-negative {
            color: #f56c6c;
        }
        
        .transaction-time {
            font-size: 12px;
            color: #909399;
            margin-top: 5px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-audit {
            background: #fff3e0;
            color: #e65100;
        }
        
        .status-success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .status-pending {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-failed {
            background: #ffebee;
            color: #c62828;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #909399;
        }
        
        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 顶部导航 -->
        <el-header class="header">
            <div class="header-content">
                <div class="logo">
                    <i class="el-icon-gavel"></i>
                    <span>拍卖系统</span>
                </div>
                <div class="nav-links">
                    
                    <el-link href="/auction/user/sessions" :underline="false">拍卖会</el-link>
                    <el-link href="/auction/user/orders" :underline="false">我的订单</el-link>
                    <el-link :underline="false" disabled style="font-weight: bold; color: #409EFF; cursor: not-allowed;">保证金</el-link>
                    <el-link href="/auction/user/notifications" :underline="false">我的通知</el-link>
                </div>
                <div class="user-info" v-if="isLoggedIn">
                    <el-badge :value="unreadNotifications" :hidden="unreadNotifications === 0" style="margin-right: 15px;">
                        <el-button icon="el-icon-bell" circle @click="goToNotifications"></el-button>
                    </el-badge>
                    <span>欢迎，{{ userInfo.nickname || userInfo.username }}</span>
                    <el-button @click="logout" type="danger" size="small">退出登录</el-button>
                </div>
                <div class="user-info" v-else>
                    <el-button @click="goToLogin" type="primary" size="small">登录</el-button>
                </div>
            </div>
        </el-header>

        <!-- 主要内容 -->
        <el-main class="main-content">
            <!-- 页面标题 -->
            <div class="page-header">
                <h1 class="page-title">保证金管理</h1>
                <p class="page-description">管理您的保证金账户，充值、提现和查看交易记录</p>
            </div>

            <!-- 保证金概览 -->
            <div class="deposit-overview">
                <div class="overview-card balance-card">
                    <i class="el-icon-wallet overview-icon balance-icon"></i>
                    <div class="overview-value">¥{{ accountBalance }}</div>
                    <div class="overview-label">账户余额</div>
                </div>
                <div class="overview-card frozen-card">
                    <i class="el-icon-lock overview-icon frozen-icon"></i>
                    <div class="overview-value">¥{{ frozenAmount }}</div>
                    <div class="overview-label">冻结金额</div>
                </div>
                <div class="overview-card available-card">
                    <i class="el-icon-check overview-icon available-icon"></i>
                    <div class="overview-value">¥{{ (availableAmount).toFixed(2) }}</div>
                    <div class="overview-label">可用金额</div>
                </div>
            </div>

            <!-- 保证金操作 -->
            <div class="deposit-actions">
                <h3 class="action-title">快速操作</h3>
                <div class="action-buttons">
                    <el-button type="primary" @click="showDepositDialog" class="action-btn">
                        <i class="el-icon-plus"></i> 充值保证金
                    </el-button>
                    <el-button type="success" @click="showWithdrawDialog" class="action-btn">
                        <i class="el-icon-minus"></i> 提现
                    </el-button>
                    <el-button type="info" @click="loadTransactions" class="action-btn">
                        <i class="el-icon-refresh"></i> 刷新记录
                    </el-button>
                </div>
            </div>

            <!-- 充值表单 -->
            <div class="deposit-form" v-if="showDepositForm">
                <h3 class="form-title">充值保证金</h3>
                
                <el-form :model="depositForm" :rules="depositRules" ref="depositFormRef" label-width="100px">
                    <el-form-item label="充值金额" prop="amount" required>
                        <el-input-number 
                            v-model="depositForm.amount" 
                            :min="1" 
                            :precision="2"
                            placeholder="请输入充值金额"
                            style="width: 100%">
                        </el-input-number>
                    </el-form-item>
                    
                    <div class="quick-amounts">
                        <div 
                            v-for="amount in quickAmounts" 
                            :key="amount"
                            class="quick-amount-btn"
                            :class="{ selected: depositForm.amount === amount }"
                            @click="setDepositAmount(amount)">
                            ¥{{ amount }}
                        </div>
                    </div>
                    
                    <el-form-item label="支付方式" prop="paymentMethod" required>
                        <el-select v-model="depositForm.paymentMethod" placeholder="请选择支付方式" style="width: 100%">
                            <el-option label="支付宝" value="alipay"></el-option>
                            <el-option label="微信支付" value="wechat"></el-option>
                            <el-option label="银行卡" value="bank"></el-option>
                        </el-select>
                    </el-form-item>
                    
                    <el-form-item>
                        <el-button type="primary" @click="submitDeposit" :loading="depositing">
                            确认充值
                        </el-button>
                        <el-button @click="cancelDeposit">取消</el-button>
                    </el-form-item>
                </el-form>
            </div>

            <!-- 提现表单 -->
            <div class="deposit-form" v-if="showWithdrawForm">
                <h3 class="form-title">提现申请</h3>
                
                <el-form :model="withdrawForm" :rules="withdrawRules" ref="withdrawFormRef" label-width="100px">
                    <el-form-item label="提现金额" prop="amount" required>
                        <el-input-number 
                            v-model="withdrawForm.amount" 
                            :min="1" 
                            :max="availableAmount"
                            :precision="2"
                            placeholder="请输入提现金额"
                            style="width: 100%">
                        </el-input-number>
                    </el-form-item>
                    
                    <el-form-item label="提现方式" prop="withdrawMethod" required>
                        <el-select v-model="withdrawForm.withdrawMethod" placeholder="请选择提现方式" style="width: 100%">
                            <el-option label="支付宝" value="alipay"></el-option>
                            <el-option label="微信" value="wechat"></el-option>
                            <el-option label="银行卡" value="bank"></el-option>
                        </el-select>
                    </el-form-item>
                    
                    <el-form-item label="收款账号" prop="account" required>
                        <el-input 
                            v-model="withdrawForm.account" 
                            placeholder="请输入收款账号">
                        </el-input>
                    </el-form-item>
                    
                    <el-form-item label="备注" prop="remark">
                        <el-input 
                            v-model="withdrawForm.remark" 
                            type="textarea" 
                            :rows="3"
                            placeholder="请输入备注信息">
                        </el-input>
                    </el-form-item>
                    
                    <el-form-item>
                        <el-button type="primary" @click="submitWithdraw" :loading="withdrawing">
                            提交申请
                        </el-button>
                        <el-button @click="cancelWithdraw">取消</el-button>
                    </el-form-item>
                </el-form>
            </div>

            <!-- 交易记录 -->
            <div class="transaction-history">
                <h3 class="history-title">交易记录</h3>
                
                <div v-if="loading" style="text-align: center; padding: 40px;">
                    <el-icon class="is-loading"><Loading /></el-icon>
                    <p>加载中...</p>
                </div>
                
                <div v-else-if="transactions.length === 0" class="empty-state">
                    <i class="el-icon-document empty-icon"></i>
                    <h3>暂无交易记录</h3>
                    <p>您还没有任何保证金交易记录</p>
                </div>
                
                <div v-else>
                    <div 
                        v-for="transaction in transactions" 
                        :key="transaction.id" 
                        class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-type" v-if="getTransactionTypeText(transaction.transactionType)">{{ getTransactionTypeText(transaction.transactionType) }}</div>
                            <div class="transaction-desc">{{ transaction.description }}</div>
                            <div class="transaction-time">{{ formatTime(transaction.createTime) }}</div>
                        </div>
                        <div class="transaction-amount" :class="getAmountClassByType(transaction.transactionType)">
                            {{ getAmountPrefix(transaction.transactionType) }}¥{{ (Number(transaction.amount || 0) / 100).toFixed(2) }}
                        </div>
                        <div class="status-badge" :class="getStatusClass(transaction.status)">
                            {{ getStatusText(transaction.status) }}
                        </div>
                    </div>
                </div>
            </div>
        </el-main>
    </div>

    <!-- Element UI JS - 使用CDN -->
    <script src="/js/vue.js"></script>
    <script src="/js/element-plus.js"></script>
    <script src="/js/axios.js"></script>
    <script src="/js/api-init.js"></script>
    
    <script>
        const { createApp } = Vue;
        const { ElMessage, ElMessageBox } = ElementPlus;

        createApp({
            data() {
                return {
                    loading: false,
                    isLoggedIn: false,
                    userInfo: {},
                    unreadNotifications: 0,
                    accountBalance: 0,
                    frozenAmount: 0,
                    
                    transactions: [],
                    showDepositForm: false,
                    showWithdrawForm: false,
                    depositing: false,
                    withdrawing: false,
                    quickAmounts: [100, 500, 1000, 2000, 5000, 10000],
                    depositForm: {
                        amount: null,
                        paymentMethod: ''
                    },
                    withdrawForm: {
                        amount: null,
                        withdrawMethod: '',
                        account: '',
                        remark: ''
                    },
                    depositRules: {
                        amount: [
                            { required: true, message: '请输入充值金额', trigger: 'blur' },
                            { type: 'number', min: 1, message: '充值金额必须大于0', trigger: 'blur' }
                        ],
                        paymentMethod: [
                            { required: true, message: '请选择支付方式', trigger: 'change' }
                        ]
                    },
                    withdrawRules: {
                        amount: [
                            { required: true, message: '请输入提现金额', trigger: 'blur' },
                            { type: 'number', min: 1, message: '提现金额必须大于0', trigger: 'blur' }
                        ],
                        withdrawMethod: [
                            { required: true, message: '请选择提现方式', trigger: 'change' }
                        ],
                        account: [
                            { required: true, message: '请输入收款账号', trigger: 'blur' }
                        ]
                    }
                }
            },
            computed: {
                availableAmount() {
                    return this.accountBalance - this.frozenAmount;
                }
            },
            mounted() {
                this.setupAxiosInterceptors();
                this.checkLoginStatus();
                if (this.isLoggedIn) {
                    this.loadAccountInfo();
                    this.loadTransactions();
                    this.loadUnreadNotifications();
                    // 每30秒刷新未读通知数
                    setInterval(() => {
                        if (this.isLoggedIn) {
                            this.loadUnreadNotifications();
                        }
                    }, 30000);
                }
            },
            methods: {
                setupAxiosInterceptors() {
                    axios.interceptors.request.use(
                        config => {
                            const token = localStorage.getItem('accessToken');
                            if (token) {
                                config.headers.Authorization = `Bearer ${token}`;
                            }
                            return config;
                        },
                        error => Promise.reject(error)
                    );
                    
                    axios.interceptors.response.use(
                        response => response,
                        async error => {
                            if (error.response && error.response.status === 401) {
                                const refreshToken = localStorage.getItem('refreshToken');
                                if (refreshToken) {
                                    try {
                                        const response = await axios.post('/api/auth/refresh', { refreshToken });
                                        if (response.data.code === 200) {
                                            const newAccessToken = response.data.data.accessToken;
                                            localStorage.setItem('accessToken', newAccessToken);
                                            error.config.headers.Authorization = `Bearer ${newAccessToken}`;
                                            return axios.request(error.config);
                                        }
                                    } catch (e) {
                                        console.error('Token刷新失败:', e);
                                    }
                                }
                                
                                localStorage.removeItem('accessToken');
                                localStorage.removeItem('refreshToken');
                                localStorage.removeItem('userInfo');
                                this.isLoggedIn = false;
                                this.userInfo = {};
                                ElMessage.error('登录已过期，请重新登录');
                                window.location.href = '/auction/login';
                            }
                            return Promise.reject(error);
                        }
                    );
                },
                
                // 检查登录状态
                checkLoginStatus() {
                    const accessToken = localStorage.getItem('accessToken');
                    const refreshToken = localStorage.getItem('refreshToken');
                    const userInfoStr = localStorage.getItem('userInfo');
                    
                    if (accessToken && refreshToken) {
                        this.isLoggedIn = true;
                        if (userInfoStr) {
                            this.userInfo = JSON.parse(userInfoStr);
                        } else {
                            this.userInfo = { username: 'buyer1', nickname: '买家1' };
                        }
                    } else {
                        this.isLoggedIn = false;
                        ElMessage.warning('请先登录');
                        window.location.href = '/auction/login';
                    }
                },
                
                async loadUnreadNotifications() {
                    try {
                        const response = await axios.get('/api/notifications/unread-count');
                        if (response.data.code === 200) {
                            this.unreadNotifications = response.data.data;
                        }
                    } catch (error) {
                        console.error('获取未读通知数失败:', error);
                    }
                },
                
                goToNotifications() {
                    window.location.href = '/auction/user/notifications';
                },
                
                // 加载账户信息
                loadAccountInfo() {
                    axios.get('/api/deposit/account')
                        .then(response => {
                            if (response.data.code === 200) {
                                const data = response.data.data;
                                const balanceCents = Number(data.balance || 0);
                                const frozenCents = Number(data.frozenAmount || 0);
                                this.accountBalance = (balanceCents / 100);
                                this.frozenAmount = (frozenCents / 100);
                            }
                        })
                        .catch(error => {
                            console.error('加载账户信息错误:', error);
                        });
                },
                
                // 加载交易记录
                loadTransactions() {
                    this.loading = true;
                    axios.get('/api/deposit/transactions')
                        .then(response => {
                            if (response.data.code === 200) {
                                const payload = response.data.data || {};
                                this.transactions = Array.isArray(payload.list) ? payload.list : [];
                            } else {
                                ElMessage.error('加载交易记录失败');
                            }
                        })
                        .catch(error => {
                            console.error('加载交易记录错误:', error);
                            ElMessage.error('加载交易记录失败');
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                },
                
                // 显示充值表单
                showDepositDialog() {
                    this.showDepositForm = true;
                    this.showWithdrawForm = false;
                },
                
                // 显示提现表单
                showWithdrawDialog() {
                    this.showWithdrawForm = true;
                    this.showDepositForm = false;
                },
                
                // 设置充值金额
                setDepositAmount(amount) {
                    this.depositForm.amount = amount;
                },
                
                // 提交充值
                submitDeposit() {
                    this.$refs.depositFormRef.validate((valid) => {
                        if (valid) {
                            this.depositing = true;
                            
                            axios.post('/api/deposit/deposit', this.depositForm)
                                .then(response => {
                                    if (response.data.code === 200) {
                                        ElMessage.success('充值申请已提交');
                                        this.cancelDeposit();
                                        this.loadAccountInfo();
                                        this.loadTransactions();
                                    } else {
                                        ElMessage.error(response.data.message || '充值失败');
                                    }
                                })
                                .catch(error => {
                                    console.error('充值错误:', error);
                                    ElMessage.error('充值失败，请稍后重试');
                                })
                                .finally(() => {
                                    this.depositing = false;
                                });
                        }
                    });
                },
                
                // 提交提现
                submitWithdraw() {
                    this.$refs.withdrawFormRef.validate((valid) => {
                        if (valid) {
                            this.withdrawing = true;
                            
                            axios.post('/api/deposit/withdraw', this.withdrawForm)
                                .then(response => {
                                    if (response.data.code === 200) {
                                        ElMessage.success('提现申请已提交');
                                        this.cancelWithdraw();
                                        this.loadAccountInfo();
                                        this.loadTransactions();
                                    } else {
                                        ElMessage.error(response.data.message || '提现失败');
                                    }
                                })
                                .catch(error => {
                                    console.error('提现错误:', error);
                                    ElMessage.error('提现失败，请稍后重试');
                                })
                                .finally(() => {
                                    this.withdrawing = false;
                                });
                        }
                    });
                },
                
                // 取消充值
                cancelDeposit() {
                    this.showDepositForm = false;
                    this.depositForm = {
                        amount: null,
                        paymentMethod: ''
                    };
                },
                
                // 取消提现
                cancelWithdraw() {
                    this.showWithdrawForm = false;
                    this.withdrawForm = {
                        amount: null,
                        withdrawMethod: '',
                        account: '',
                        remark: ''
                    };
                },
                
                // 获取交易类型文本（数值型）
                getTransactionTypeText(type) {
                    const t = Number(type);
                    const typeMap = {
                        1: '充值',
                        2: '冻结',
                        3: '解冻',
                        4: '扣除',
                        5: '退还',
                        6: '提现',
                        7: '支付'
                    };
                    return typeMap[t] || '-';
                },
                
                // 获取金额样式类（按类型判断正负：1充值/4解冻/6退还为正；2提现/3冻结/5扣除为负）
                getAmountClassByType(type) {
                    const t = Number(type);
                    const positiveTypes = [1, 4, 6];
                    return positiveTypes.includes(t) ? 'amount-positive' : 'amount-negative';
                },

                // 前缀符号（同上规则）
                getAmountPrefix(type) {
                    const t = Number(type);
                    const positiveTypes = [1, 4, 6];
                    return positiveTypes.includes(t) ? '+' : '-';
                },
                
                // 获取状态样式类（1成功 2失败 3处理中）
                getStatusClass(status) {
                    const s = Number(status);
                    const statusMap = {
                        0: 'status-audit',      // 待审核 - 橙色
                        1: 'status-success',    // 成功 - 绿色
                        2: 'status-failed',     // 失败 - 红色
                        3: 'status-pending'     // 处理中 - 蓝色
                    };
                    return statusMap[s] || 'status-pending';
                },
                
                // 获取状态文本（数值型）
                getStatusText(status) {
                    const s = Number(status);
                    const statusMap = {
                        0: '待审核',
                        1: '成功',
                        2: '已拒绝',
                        3: '处理中'
                    };
                    return statusMap[s] || '—';
                },
                
                // 格式化时间
                formatTime(time) {
                    if (!time) return '—';
                    const d = new Date(time);
                    if (isNaN(d.getTime())) return '—';
                    return d.toLocaleString('zh-CN');
                },
                
                // 跳转到登录页面
                goToLogin() {
                    window.location.href = '/auction/login';
                },
                
                // 退出登录
                logout() {
                    ElMessageBox.confirm('确定要退出登录吗？', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        // 清理本地Token并跳转登录
                        localStorage.removeItem('accessToken');
                        localStorage.removeItem('refreshToken');
                        delete axios.defaults.headers.common['Authorization'];
                        axios.post('/api/auth/logout').finally(() => {
                            this.isLoggedIn = false;
                            this.userInfo = {};
                            ElMessage.success('已退出登录');
                            window.location.href = '/auction/login';
                        });
                    });
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
    
</body>
</html>
